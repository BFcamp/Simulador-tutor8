<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Tutor IA - V19 (Editable & Perfected)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        .loader {
            border: 4px solid #f3f3ff; border-top: 4px solid #3498db; border-radius: 50%;
            width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tabs */
        .tab-button { transition: all 0.2s ease-in-out; border-bottom-width: 3px; border-color: transparent; }
        .tab-button.active { border-color: #2563eb; color: #1d4ed8; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        
        /* Cards & Interactive Elements */
        .mode-card {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 32px; border: 2px solid #e5e7eb; border-radius: 16px; transition: all 0.2s;
            cursor: pointer; text-align: center; background-color: #f9fafb;
        }
        .mode-card:hover {
            border-color: #2563eb; background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(-4px);
        }
        
        /* Progress Bars (Static) */
        .progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 12px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-color: #2563eb; border-radius: 9999px; transition: width 0.5s ease-in-out; }

        /* NUEVO: Progress Modal Overlay */
        #progress-modal {
            display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.75); 
            z-index: 100; align-items: center; justify-content: center;
        }
        .progress-box {
            background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .progress-step { margin-top: 10px; font-size: 0.9rem; color: #6b7280; font-style: italic; min-height: 20px; }
        .main-progress-bar-container {
            width: 100%; height: 16px; background-color: #e5e7eb; border-radius: 10px; overflow: hidden; margin-top: 20px;
        }
        .main-progress-bar-fill {
            height: 100%; background: linear-gradient(90deg, #2563eb, #3b82f6); width: 0%; 
            transition: width 0.4s ease; border-radius: 10px;
        }

        /* Choice Mode Styles */
        .mcq-option {
            display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px;
            border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;
        }
        .mcq-option:hover { background-color: #f3f4f6; }
        .mcq-option.selected { border-color: #2563eb; background-color: #eff6ff; }
        .mcq-option.correct { border-color: #10b981; background-color: #d1fae5; }
        .mcq-option.incorrect { border-color: #ef4444; background-color: #fee2e2; }
        
        .hint-box {
            background-color: #fffbeb; border-left: 4px solid #f59e0b; color: #92400e;
            padding: 12px; margin-top: 12px; font-size: 0.9rem; display: none; border-radius: 4px;
        }
        
        .flashcard-feedback {
            display: none; font-size: 0.8rem; font-weight: 600; color: #057a55;
            background-color: #d1fae5; padding: 6px 10px; border-radius: 6px;
            margin-top: 10px; text-align: center;
        }
        
        /* Practice Mode & Justification */
        .practice-mode-menu {
            display: flex; flex-direction: column; gap: 12px; padding: 16px;
            background-color: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;
        }
        .practice-mode-btn {
            padding: 12px; font-size: 1rem; font-weight: 600; border-radius: 8px;
            border: 2px solid #d1d5db; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .practice-mode-btn:hover { background-color: #eff6ff; border-color: #2563eb; }
        .practice-mode-btn span { font-size: 0.8rem; font-weight: 400; color: #4b5563; }
        
        .justification-accordion-btn {
            width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;
            font-weight: 500; font-size: 0.9rem; color: #1f2937; margin-top: 12px;
        }
        .justification-accordion-btn:hover { background-color: #f3f4f6; }
        .justification-accordion-btn[aria-expanded="true"] .lucide-chevron-down { transform: rotate(180deg); }
        .justification-content {
             display: none; padding: 12px; border-left: 2px solid #e5e7eb; margin-top: 4px;
             font-size: 0.9rem; background-color: #fdfdfd;
        }
        .justification-content.open { display: block; }


        /* General Reused Styles */
        .qa-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; position: relative; }
        .qa-card img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 8px; }
        .delete-qa-btn { position: absolute; top: 12px; right: 12px; background: #fee2e2; color: #dc2626; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5;}
        .edit-qa-btn { position: absolute; top: 12px; right: 48px; background: #dbeafe; color: #2563eb; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5;}
        
        /* Accordion Styles */
        .accordion-btn {
            width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;
            font-weight: 600; font-size: 1.1rem; color: #1f2937; margin-bottom: 4px;
        }
        .accordion-btn:hover { background-color: #f3f4f6; }
        .accordion-content { display: none; padding-left: 16px; border-left: 2px solid #e5e7eb; margin-bottom: 12px; }
        .open { display: block; }
        .accordion-btn .toggle-icon { transition: transform 0.2s; }
        .accordion-btn[aria-expanded="true"] .toggle-icon { transform: rotate(180deg); }
        .accordion-btn[aria-expanded="true"] .lucide-chevron-down { transform: rotate(180deg); }


        /* Overdue Disclaimer Style */
        .overdue-disclaimer {
            background-color: #fef2f2; /* red-50 */
            border: 1px solid #fca5a5; /* red-300 */
            border-left-width: 4px;
            border-left-color: #ef4444; /* red-500 */
            color: #b91c1c; /* red-700 */
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 16px;
        }
        
        /* Botón de eliminar en Admin Temas */
        .delete-question-btn {
            background-color: #fee2e2; color: #dc2626; border-radius: 50%;
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; margin-left: 8px;
        }
        .delete-question-btn:hover { background-color: #fecaca; }

        /* --- INICIO: Estilos para "Modo Estudio" --- */
        .syllabus-browser .unit-toggle-btn {
            font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 8px; border-bottom-width: 1px;
        }
        .syllabus-browser .unit-topics-container { border-left: 2px solid #e5e7eb; }
        .syllabus-topic-btn {
            display: block; width: 100%; text-align: left; padding: 12px 16px; font-size: 1rem; font-weight: 500;
            color: #374151; border-radius: 8px; transition: background-color 0.2s; cursor: pointer;
        }
        .syllabus-topic-btn:hover { background-color: #f4f7f6; }
        .syllabus-topic-btn:not(:last-child) { margin-bottom: 4px; }
        
        .guide-summary {
            font-size: 1.125rem; color: #374151; background-color: #f9fafb; padding: 16px;
            border-radius: 8px; border-left: 4px solid #2563eb; margin-bottom: 24px;
        }
        .subtopic-block {
            background-color: white; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .subtopic-header {
            padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;
        }
        .subtopic-header h4 { font-size: 1.25rem; font-weight: 600; color: #111827; }
        .importance-badge {
            padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
        }
        .importance-badge-alta { background-color: #fee2e2; color: #b91c1c; }
        .importance-badge-media { background-color: #fef3c7; color: #b45309; }
        .importance-badge-baja { background-color: #dbeafe; color: #1e40af; }
        
        .subtopic-body { padding: 16px; }
        .ai-justification { font-size: 0.875rem; color: #4b5563; font-style: italic; margin-bottom: 16px; }
        .question-item { border-top: 1px solid #f3f4f6; padding-top: 16px; }
        .question-item .question-text { font-weight: 600; color: #1f2937; }
        .sub-question-loader { display: none; }

        .generate-more-btn {
            margin-top: 16px; width: 100%; padding: 10px; font-weight: 500; background-color: #f3f4f6;
            border-top: 1px solid #e5e7eb; color: #1f2937; transition: background-color 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; cursor: pointer;
        }
        .generate-more-btn:hover { background-color: #e5e7eb; }
        .sub-question-container { padding: 0 16px 16px 16px; }
        
        .answer-loader {
            border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 16px; height: 16px;
            animation: spin 1s linear infinite; display: inline-block; margin-left: 8px;
        }
        .answer-text {
            font-size: 0.9rem; color: #1f2937; margin-top: 10px; border-radius: 4px; white-space: pre-wrap;
            background-color: #f9fafb; border: 1px solid #e5e7eb; border-left: 4px solid #2563eb; padding: 10px 14px;
        }
        .audio-player-container audio { width: 100%; height: 38px; margin-top: 8px; }

                /* --- PARCHE 1: MODO ORGANIZACIÓN & REPASO --- */
        
        /* Contenedores de organización (Drag & Drop) */
        .org-container {
            border: 2px dashed #cbd5e1; border-radius: 12px; padding: 16px; min-height: 100px;
            background-color: #f8fafc; margin-bottom: 16px; transition: all 0.2s;
        }
        .org-container.drag-over { background-color: #eff6ff; border-color: #3b82f6; }
        
        /* Elementos arrastrables (Temas) */
        .org-topic-item {
            background: white; border: 1px solid #e2e8f0; padding: 10px; margin-bottom: 8px; border-radius: 8px;
            cursor: grab; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .org-topic-item:active { cursor: grabbing; }
        .org-topic-item.dragging { opacity: 0.5; transform: scale(0.98); }

        /* Tarjetas de Grupo en Repaso */
        .review-group-card {
            background: white; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 16px; overflow: hidden;
            transition: all 0.2s;
        }
        .review-group-header {
            padding: 16px; background-color: #fff; cursor: pointer; border-bottom: 1px solid transparent;
        }
        .review-group-card.expanded .review-group-header { border-bottom-color: #e5e7eb; background-color: #f9fafb; }
        
        .review-group-body { display: none; padding: 16px; background-color: #ffffff; }
        .review-group-card.expanded .review-group-body { display: block; }

        /* Barra de progreso específica para grupos */
        .group-progress-bg { height: 8px; width: 100%; background-color: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .group-progress-fill { height: 100%; background-color: #10b981; border-radius: 4px; width: 0%; transition: width 0.5s; }
    
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Modal Sincronización -->
    <div id="sync-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md w-full">
            <h3 class="text-2xl font-bold text-gray-800">Configurar Sincronización</h3>
            <p class="mt-3 text-gray-600">Para mantener tus datos, usa el mismo ID en todos tus dispositivos.</p>
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700">Tu ID actual o nuevo:</label>
                <input type="text" id="sync-id-input" class="w-full mt-1 p-2 border border-gray-300 rounded-lg shadow-sm">
                <button id="save-sync-id" class="mt-3 w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Usar este ID</button>
                <button id="generate-sync-id" class="mt-3 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Generar Nuevo ID</button>
            </div>
        </div>
    </div>

    <!-- Modal de Progreso -->
    <div id="progress-modal">
        <div class="progress-box">
            <h3 id="progress-title" class="text-xl font-bold text-gray-800">Procesando...</h3>
            <div class="main-progress-bar-container">
                <div id="progress-bar-fill" class="main-progress-bar-fill"></div>
            </div>
            <p id="progress-step" class="progress-step">Iniciando...</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 sm:p-8">
        
        <!-- Header -->
        <header class="mb-8 bg-white shadow-lg rounded-xl p-6 sm:p-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">Simulador Tutor IA</h1>
            <p class="text-lg text-gray-600">Entrenamiento inteligente: Oral, Choice y Repaso Espaciado.</p>
            
            <!-- Selector de Materia -->
            <div id="subject-header" class="mt-6 border-t border-gray-200 pt-4">
                <label class="block text-base font-semibold text-gray-800 mb-2">Materia Actual:</label>
                <div class="flex flex-col sm:flex-row sm:space-x-2">
                    <select id="subject-selector" class="w-full sm:w-1/2 p-2.5 border border-gray-300 rounded-lg bg-white">
                        <option value="">-- Seleccionar --</option>
                        <option value="all">-- Ver Todas --</option>
                    </select>
                    <input type="text" id="new-subject-name" placeholder="Nueva materia..." class="mt-2 sm:mt-0 w-full sm:w-1/2 p-2.5 border border-gray-300 rounded-lg">
                    <button id="add-subject-btn" class="mt-2 sm:mt-0 px-5 py-2.5 bg-gray-800 text-white font-semibold rounded-lg hover:bg-gray-900">Crear</button>
                </div>
            </div>
            <div id="sync-id-display" class="mt-3 text-xs text-gray-500 flex items-center gap-2" style="display: none;">
                <span>ID: <span id="user-id" class="font-mono bg-gray-100 p-1 rounded">...</span></span>
                <button id="change-sync-id" class="px-2 py-0.5 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300">Cambiar ID</button>
            </div>
        </header>

        <!-- Navegación Tabs -->
        <div class="mb-6 overflow-x-auto">
            <nav class="flex space-x-6 border-b border-gray-300 min-w-max" aria-label="Tabs">
                <button id="tab-material-btn" class="tab-button active py-4 text-lg font-semibold text-gray-500">Material</button>
                <button id="tab-choice-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Modo Choice</button>
                <button id="tab-simulador-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Modo Oral</button>
                <button id="tab-review-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Repasar</button>
                <button id="tab-topics-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Administrar Temas</button>
                <button id="tab-roadmap-btn" class="tab-button py-4 text-lg font-semibold text-gray-500">Hoja de Ruta</button>
            </nav>
        </div>

        <div class="bg-white shadow-xl rounded-xl p-6 sm:p-8 min-h-[500px]">
            
            <!-- TAB: MATERIAL -->
            <div id="tab-material" class="tab-panel active space-y-6">
                <p class="text-gray-600">Carga aquí la base de conocimiento. Es fundamental para que la IA clasifique preguntas y detecte temas.</p>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-lg font-semibold text-gray-800">Plan de Estudio / Temario</label>
                        <button class="upload-pdf-btn px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200" data-target="syllabus">Subir PDF</button>
                    </div>
                    <textarea id="syllabus" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Copia aquí el programa de la materia..."></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-lg font-semibold text-gray-800">Teoría / Apuntes / Libros</label>
                        <button class="upload-pdf-btn px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200" data-target="theory">Subir PDF</button>
                    </div>
                    <textarea id="theory" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Copia aquí apuntes clave o resúmenes..."></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-lg font-semibold text-gray-800">Experiencias Orales (Opcional)</label>
                        <button class="upload-pdf-btn px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200" data-target="experiences">Subir PDF</button>
                    </div>
                    <textarea id="experiences" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Preguntas que hicieron a otros alumnos..."></textarea>
                </div>
                <button id="save-material" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Guardar Material en Nube</button>
                <div id="save-status" class="text-center mt-2 font-medium"></div>
            </div>

            <!-- TAB: MODO CHOICE -->
            <div id="tab-choice" class="tab-panel space-y-6">
                <div id="choice-mode-selection" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="btn-load-choice" class="mode-card">
                        <svg data-lucide="upload-cloud" class="w-12 h-12 text-purple-600 mb-4"></svg>
                        <h3 class="text-xl font-bold">Cargar o Generar</h3>
                        <p class="text-gray-500 mt-2">Analizar PDFs o generar preguntas desde tu teoría.</p>
                    </div>
                    <div id="btn-practice-choice" class="mode-card">
                        <svg data-lucide="check-circle-2" class="w-12 h-12 text-green-600 mb-4"></svg>
                        <h3 class="text-xl font-bold">Practicar Choice</h3>
                        <p class="text-gray-500 mt-2">Practicar las preguntas clasificadas por tema.</p>
                    </div>
                </div>

                <div id="choice-load-container" class="hidden space-y-6">
                    <button id="back-mode-choice-1" class="text-sm text-blue-600 font-bold flex items-center hover:underline">
                        <svg data-lucide="arrow-left" class="w-4 h-4 mr-1"></svg> Volver a selección
                    </button>
                    
                    <div class="p-6 border rounded-lg bg-gray-50">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">1. Analizar Exámenes Existentes</h3>
                        <p class="text-sm text-gray-500 mb-4">Sube PDFs de choice o pega el texto para que la IA lo analice y clasifique.</p>
                        <div class="flex gap-2 mb-2">
                            <button class="upload-pdf-btn flex-1 py-2 bg-purple-100 text-purple-700 text-sm font-bold rounded hover:bg-purple-200" data-target="choice-raw">Subir PDF Choice</button>
                        </div>
                        <textarea id="choice-raw" rows="5" class="w-full p-2 border border-gray-300 rounded text-sm" placeholder="Pega aquí el texto de los exámenes..."></textarea>
                        <button id="analyze-choice-btn" class="w-full mt-2 py-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 transition-all">
                            Analizar y Clasificar
                        </button>
                        <div id="analyze-choice-loader" class="hidden text-center mt-2">
                            <div class="loader w-6 h-6 border-2"></div>
                            <p class="text-xs text-gray-500 mt-1" id="choice-loader-text">Analizando...</p>
                        </div>
                    </div>

                    <div class="p-6 border rounded-lg bg-gray-50">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">2. Generar Choice desde Teoría</h3>
                        <p class="text-sm text-gray-500 mb-4">Crea preguntas nuevas usando el contenido de tu pestaña "Material" (Teoría y Syllabus).</p>
                        <div class="flex items-center gap-4">
                            <label for="generate-choice-qty" class="font-semibold text-gray-700">Cantidad a generar:</label>
                            <select id="generate-choice-qty" class="p-2 border border-gray-300 rounded-lg">
                                <option value="5">5 Preguntas</option>
                                <option value="10">10 Preguntas</option>
                                <option value="20">20 Preguntas</option>
                            </select>
                            <button id="generate-choice-btn" class="flex-1 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700 transition-all">
                                Generar Preguntas
                            </button>
                        </div>
                        <div id="generate-choice-loader" class="loader hidden"></div>
                    </div>
                </div>

                <div id="choice-practice-container" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <button id="back-mode-choice-2" class="text-sm text-blue-600 font-bold flex items-center hover:underline">
                            <svg data-lucide="arrow-left" class="w-4 h-4 mr-1"></svg> Volver a selección
                        </button>
                        <button id="toggle-sidebar-btn" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200" title="Modo Enfocado">
                            <svg data-lucide="panel-left-close" class="w-5 h-5"></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div id="choice-sidebar-col" class="lg:col-span-1 space-y-6 border-r border-gray-200 pr-4">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Practicar por Tema</h3>
                            <div id="choice-loader-practice" class="loader hidden"></div>
                            <div id="choice-topics-list" class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                                <p class="text-sm text-gray-400 italic">No hay preguntas analizadas aún.</p>
                            </div>
                        </div>
                        <div id="choice-main-col" class="lg:col-span-2">
                            <div id="choice-practice-area" class="h-full flex flex-col justify-center items-center text-center p-8 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                                <svg data-lucide="check-circle-2" class="w-16 h-16 text-gray-300 mb-4"></svg>
                                <h3 class="text-xl font-semibold text-gray-600">Zona de Práctica</h3>
                                <p class="text-gray-500 max-w-md mt-2">Selecciona un tema de la izquierda para comenzar a practicar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 

            <!-- TAB: MODO ORAL / ESTUDIO -->
            <div id="tab-simulador" class="tab-panel space-y-6">
                <div id="mode-selection" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="btn-study-mode" class="mode-card">
                        <svg data-lucide="book-open" class="w-12 h-12 text-blue-600 mb-4"></svg>
                        <h3 class="text-xl font-bold">Modo Estudio Guiado</h3>
                        <p class="text-gray-500 mt-2">Genera una estructura de temas inteligente usando *todo* tu material.</p>
                    </div>
                    <div id="btn-exam-mode" class="mode-card">
                        <svg data-lucide="swords" class="w-12 h-12 text-red-600 mb-4"></svg>
                        <h3 class="text-xl font-bold">Simulacro Examen</h3>
                        <p class="text-gray-500 mt-2">Preguntas al azar de toda la materia.</p>
                    </div>
                </div>
                                <div id="study-container" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <button id="back-mode-1" class="text-sm text-blue-600 font-bold flex items-center">
                            <svg data-lucide="arrow-left" class="w-4 h-4 mr-1"></svg> Volver
                        </button>
                        <!-- NUEVO BOTÓN REGENERAR (oculto por defecto hasta que se cargue algo) -->
                        <button id="regenerate-syllabus-btn" class="text-xs px-3 py-1 bg-red-100 text-red-600 font-bold rounded hover:bg-red-200 flex items-center gap-1" style="display: none;">
                            <svg data-lucide="refresh-cw" class="w-3 h-3"></svg> Regenerar Estructura
                        </button>
                    </div>
                    
                    <h2 class="text-2xl font-bold mb-2">Estructura de Temas (IA)</h2>
                    <p class="text-sm text-gray-500 mb-4">Esta estructura se genera usando tu Syllabus, Teoría y Exámenes.</p>
                    
                    <div id="syllabus-browser" class="bg-gray-50 p-4 rounded-lg max-h-[400px] overflow-y-auto">
                        <div class="loader"></div>
                        <p class="text-center text-gray-500">Analizando todo el material...</p>
                    </div>
                    
                    <div id="study-output" class="mt-6 space-y-6"></div>
                </div>


                <div id="exam-container" class="hidden">
                    <button id="back-mode-2" class="mb-4 text-sm text-blue-600 font-bold flex items-center"><svg data-lucide="arrow-left" class="w-4 h-4 mr-1"></svg> Volver</button>
                    <div class="bg-white p-6 rounded-lg border border-gray-200 text-center">
                        <label class="font-bold text-gray-700">Cantidad de preguntas:</label>
                        <input type="range" id="exam-qty" min="1" max="5" value="3" class="w-full mt-2">
                        <button id="generate-exam-btn" class="mt-4 px-6 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700">Generar Preguntas</button>
                    </div>
                    <div id="exam-output" class="mt-6 space-y-6"></div>
                </div>
            </div>

            <!-- TAB: REPASAR -->
                        <!-- TAB: REPASAR (PARCHE 3 APLICADO) -->
            <div id="tab-review" class="tab-panel space-y-6">
                
                <!-- Header de la Pestaña -->
                <div class="flex justify-between items-center bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <div>
                        <h2 id="review-title" class="text-lg font-bold text-blue-900">Repaso (SRS)</h2>
                        <p id="review-subtitle" class="text-sm text-blue-700">Tarjetas de "Modo Oral" y flashcards.</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <span id="review-count" class="text-3xl font-extrabold text-blue-600">0</span>
                            <span class="text-xs block text-gray-500">pendientes</span>
                        </div>
                        <!-- Nuevo Botón Toggle Organizar -->
                        <button id="toggle-org-mode-btn" class="ml-4 px-4 py-2 bg-white border border-blue-200 text-blue-700 font-bold rounded-lg hover:bg-blue-50 text-sm flex items-center gap-2 shadow-sm transition-all">
                            <svg data-lucide="layout" class="w-4 h-4"></svg> Organizar
                        </button>
                    </div>
                </div>

                <div id="review-overdue" class="overdue-disclaimer" style="display: none;"></div>
                <div id="review-loader" class="loader hidden"></div>

                <!-- VISTA 1: MODO NORMAL (Lista de Contenedores y Temas Sueltos) -->
                <div id="review-view-mode">
                    <!-- Aquí aparecerán los grupos creados -->
                    <div id="review-containers-list" class="space-y-4 mb-6"></div>
                    
                    <h3 class="text-gray-700 font-bold mb-2 text-sm uppercase tracking-wide">Temas Sueltos / Sin Agrupar</h3>
                    <div id="review-list" class="space-y-4 min-h-[100px]">
                        <p class="text-gray-400 text-center py-10">Cargando repasos...</p>
                    </div>
                </div>

                <!-- VISTA 2: MODO ORGANIZACIÓN (Drag & Drop) - Oculto por defecto -->
                <div id="review-org-mode" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 h-[600px]">
                    
                    <!-- Columna Izquierda: Temas Disponibles (Origen) -->
                    <div class="flex flex-col h-full border rounded-xl bg-white overflow-hidden shadow-sm">
                        <div class="p-4 border-b bg-gray-50 font-bold text-gray-700 flex justify-between items-center">
                            <span>Temas Disponibles</span>
                            <span class="text-xs font-normal text-gray-500">(Arrastra a la derecha)</span>
                        </div>
                        <div id="org-pool-list" class="p-4 overflow-y-auto flex-1 bg-gray-100 space-y-2">
                            <!-- Aquí se inyectarán los temas sueltos -->
                        </div>
                    </div>

                    <!-- Columna Derecha: Contenedores (Destino) -->
                    <div class="flex flex-col h-full space-y-4">
                        <!-- Input para crear nuevo grupo -->
                        <div class="bg-white p-4 rounded-xl border shadow-sm">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Crear Nuevo Grupo</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-container-name" placeholder="Ej: Parcial Mayo, Unidad 1..." class="flex-1 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <button id="create-container-btn" class="px-4 py-2 bg-green-600 text-white font-bold rounded-lg text-sm hover:bg-green-700 transition-colors">Crear</button>
                            </div>
                        </div>
                        
                        <!-- Área donde aparecen los grupos para soltar items -->
                        <div id="org-containers-area" class="flex-1 overflow-y-auto space-y-4 pr-2 pb-2">
                            <!-- Aquí se inyectarán los contenedores -->
                        </div>
                    </div>
                </div>

            </div>



            <!-- TAB: ADMINISTRAR TEMAS -->
            <div id="tab-topics" class="tab-panel space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">Administrar Temas</h2>
                <p class="text-gray-600">Organiza tus temas. Fusiona duplicados, renombra y crea subtemas para practicar.</p>
                
                <div id="topic-manager-controls" class="flex gap-2 p-4 bg-gray-50 rounded-lg border">
                    <button id="merge-topics-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg text-sm disabled:opacity-50" disabled>Fusionar Seleccionados</button>
                    <button id="create-subtopic-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg text-sm disabled:opacity-50" disabled>Crear Subtema</button>
                </div>
                <div id="topic-manager-loader" class="text-center hidden">
                    <div class="loader"></div>
                    <p class="text-gray-500">Cargando todos los temas...</p>
                </div>
                <div id="topic-manager-list" class="space-y-2"></div>
            </div>

            <!-- TAB: HOJA de RUTA -->
            <div id="tab-roadmap" class="tab-panel space-y-6">
                <h2 id="roadmap-title" class="text-2xl font-bold text-gray-800">Hoja de Ruta</h2>
                <p id="roadmap-subtitle" class="text-gray-600">Cronograma de tus próximos repasos (Orales y Flashcards).</p>
                
                <div id="roadmap-loader" class="loader hidden"></div>
                <div id="roadmap-list" class="space-y-6"></div>
                <div id="roadmap-practice-session" class="hidden"></div>
            </div>

        </div>
    </div>

    <!-- Modales -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-sm w-full shadow-2xl">
            <h3 id="error-title" class="text-red-600 font-bold text-lg mb-2">Atención</h3>
            <p id="error-msg" class="text-gray-700 mb-4"></p>
            <button onclick="document.getElementById('error-modal').style.display='none'" class="w-full py-2 bg-gray-200 font-bold rounded hover:bg-gray-300">Cerrar</button>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-sm w-full shadow-2xl">
            <h3 id="confirm-title" class="text-yellow-600 font-bold text-lg mb-2">¿Estás seguro?</h3>
            <p id="confirm-msg" class="text-gray-700 mb-4">Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button id="confirm-no" class="px-4 py-2 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-yes" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Sí, Eliminar</button>
            </div>
        </div>
    </div>

    <div id="edit-qa-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg max-w-lg w-full shadow-2xl">
            <h3 id="edit-qa-title" class="text-xl font-bold text-gray-800 mb-4">Editar Flashcard</h3>
            <input type="hidden" id="edit-qa-id"><input type="hidden" id="edit-qa-subject"><input type="hidden" id="edit-qa-unit"><input type="hidden" id="edit-qa-topic">
            <div class="space-y-3">
                <div><label class="block text-sm font-medium text-gray-700">Pregunta</label><textarea id="edit-qa-question" rows="3" class="w-full p-2 border border-gray-300 rounded"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700">Respuesta</label><textarea id="edit-qa-answer" rows="4" class="w-full p-2 border border-gray-300 rounded"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700">URL de Imagen (Opcional)</label><input type="text" id="edit-qa-image" class="w-full p-2 border border-gray-300 rounded" placeholder="https://ejemplo.com/imagen.jpg"></div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="edit-qa-cancel" class="px-4 py-2 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="edit-qa-save" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>

    <div id="edit-mcq-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Editar Pregunta Choice</h3>
            <input type="hidden" id="edit-mcq-id">
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Pregunta</label><textarea id="edit-mcq-question" rows="3" class="w-full p-2 border border-gray-300 rounded"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700">Opciones (Marcar la correcta)</label><div id="edit-mcq-options-container" class="space-y-2 mt-1"></div></div>
                <div><label class="block text-sm font-medium text-gray-700">Justificación (para Modo Inicial)</label><textarea id="edit-mcq-justification" rows="4" class="w-full p-2 border border-gray-300 rounded"></textarea></div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="edit-mcq-cancel" class="px-4 py-2 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="edit-mcq-save" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <input type="file" id="hidden-pdf-input" accept=".pdf" style="display: none;">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, getDoc, collection, addDoc, query, 
            where, onSnapshot, updateDoc, deleteDoc, getDocs, serverTimestamp, 
            orderBy, writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyAVbIeEAHBfKU5eDqsELTyXkAcM-m5qUUM",
             authDomain: "simulador-examen-oral.firebaseapp.com",
             projectId: "simulador-examen-oral",
             storageBucket: "simulador-examen-oral.firebasestorage.app",
             messagingSenderId: "64722873532",
             appId: "1:64722873532:web:2f708ee4a62366598c34b9"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = localStorage.getItem('my_sync_userId');
        let currentSubject = null;
        let allSubjectNames = [];
        let currentTab = 'tab-material';
        let unsubscribeReview = null;
        let unsubscribeRoadmap = null;
        
        let cachedMcqs = []; 
        let currentPracticeTopic = null;
        let allPracticeTopicNames = []; 
        let currentPracticeQuestions = [];
        let currentQuestionIndex = 0;
        let currentQuizCorrect = 0;
        let currentQuizWrong = 0;
        let currentQuizWrongCards = [];
        let isFlashcardCreated = false;
        let currentPracticeMode = 'normal';

                const els = {
            tabs: document.querySelectorAll('.tab-button'),
            panels: document.querySelectorAll('.tab-panel'),
            subjectHeader: document.getElementById('subject-header'),
            subjectSelect: document.getElementById('subject-selector'),
            newSubjectInput: document.getElementById('new-subject-name'),
            addSubjectBtn: document.getElementById('add-subject-btn'),
            pdfInput: document.getElementById('hidden-pdf-input'),
            choiceModeSelection: document.getElementById('choice-mode-selection'),
            btnLoadChoice: document.getElementById('btn-load-choice'),
            btnPracticeChoice: document.getElementById('btn-practice-choice'),
            choiceLoadContainer: document.getElementById('choice-load-container'),
            choicePracticeContainer: document.getElementById('choice-practice-container'),
            backModeChoice1: document.getElementById('back-mode-choice-1'),
            backModeChoice2: document.getElementById('back-mode-choice-2'),
            choiceRaw: document.getElementById('choice-raw'),
            analyzeBtn: document.getElementById('analyze-choice-btn'),
            analyzeChoiceLoader: document.getElementById('analyze-choice-loader'),
            choiceLoaderText: document.getElementById('choice-loader-text'), 
            generateChoiceQty: document.getElementById('generate-choice-qty'),
            generateChoiceBtn: document.getElementById('generate-choice-btn'),
            generateChoiceLoader: document.getElementById('generate-choice-loader'),
            choiceList: document.getElementById('choice-topics-list'),
            choiceLoaderPractice: document.getElementById('choice-loader-practice'),
            practiceArea: document.getElementById('choice-practice-area'),
            studyModeBtn: document.getElementById('btn-study-mode'),
            examModeBtn: document.getElementById('btn-exam-mode'),
            modeSelection: document.getElementById('mode-selection'),
            studyContainer: document.getElementById('study-container'),
            examContainer: document.getElementById('exam-container'),
            syllabusBrowser: document.getElementById('syllabus-browser'),
            reviewTitle: document.getElementById('review-title'),
            reviewSubtitle: document.getElementById('review-subtitle'),
            reviewOverdue: document.getElementById('review-overdue'),
            reviewLoader: document.getElementById('review-loader'),
            reviewList: document.getElementById('review-list'),
            reviewCount: document.getElementById('review-count'),
            topicManagerLoader: document.getElementById('topic-manager-loader'),
            topicManagerList: document.getElementById('topic-manager-list'),
            mergeTopicsBtn: document.getElementById('merge-topics-btn'),
            createSubtopicBtn: document.getElementById('create-subtopic-btn'),
            roadmapTitle: document.getElementById('roadmap-title'),
            roadmapSubtitle: document.getElementById('roadmap-subtitle'),
            roadmapLoader: document.getElementById('roadmap-loader'),
            roadmapList: document.getElementById('roadmap-list'),
            roadmapPractice: document.getElementById('roadmap-practice-session'),
            editQaModal: document.getElementById('edit-qa-modal'),
            editQaTitle: document.getElementById('edit-qa-title'),
            editQaId: document.getElementById('edit-qa-id'),
            editQaSubject: document.getElementById('edit-qa-subject'),
            editQaUnit: document.getElementById('edit-qa-unit'),
            editQaTopic: document.getElementById('edit-qa-topic'),
            editQaQuestion: document.getElementById('edit-qa-question'),
            editQaAnswer: document.getElementById('edit-qa-answer'),
            editQaImage: document.getElementById('edit-qa-image'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmMsg: document.getElementById('confirm-msg'),
            confirmYes: document.getElementById('confirm-yes'),
            confirmNo: document.getElementById('confirm-no'),
            editMcqModal: document.getElementById('edit-mcq-modal'),
            editMcqId: document.getElementById('edit-mcq-id'),
            editMcqQuestion: document.getElementById('edit-mcq-question'),
            editMcqOptionsContainer: document.getElementById('edit-mcq-options-container'),
            editMcqJustification: document.getElementById('edit-mcq-justification'),
            progressModal: document.getElementById('progress-modal'),
            progressTitle: document.getElementById('progress-title'),
            progressBarFill: document.getElementById('progress-bar-fill'),
            progressStep: document.getElementById('progress-step'),
            
            // --- NUEVOS ELEMENTOS DEL PARCHE 4 ---
            regenerateSyllabusBtn: document.getElementById('regenerate-syllabus-btn'),
            toggleOrgModeBtn: document.getElementById('toggle-org-mode-btn'),
            createContainerBtn: document.getElementById('create-container-btn'),
            newContainerInput: document.getElementById('new-container-name'),
            reviewViewMode: document.getElementById('review-view-mode'),
            reviewOrgMode: document.getElementById('review-org-mode'),
            reviewContainersList: document.getElementById('review-containers-list'),
            orgPoolList: document.getElementById('org-pool-list'),
            orgContainersArea: document.getElementById('org-containers-area')
        };


        function setupListeners() {
            els.tabs.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.target.id.replace('-btn', '');
                    switchTab(target);
                });
            });
            document.getElementById('save-sync-id').onclick = () => {
                const val = document.getElementById('sync-id-input').value.trim();
                if(val) { localStorage.setItem('my_sync_userId', val); location.reload(); }
            };
            document.getElementById('generate-sync-id').onclick = () => {
                localStorage.setItem('my_sync_userId', crypto.randomUUID()); location.reload();
            };
            document.getElementById('change-sync-id').onclick = () => {
                const newId = prompt("Ingresa tu ID de Sincronización. (Dejar en blanco para generar uno nuevo).", userId);
                if (newId === null) return;
                if (newId.trim() === "") localStorage.setItem('my_sync_userId', crypto.randomUUID());
                else localStorage.setItem('my_sync_userId', newId.trim());
                location.reload();
            };
            els.addSubjectBtn.onclick = createSubject;
            els.subjectSelect.onchange = changeSubject;
            document.querySelectorAll('.upload-pdf-btn').forEach(btn => {
                btn.onclick = () => {
                    els.pdfInput.dataset.target = btn.dataset.target;
                    els.pdfInput.click();
                };
            });
            els.pdfInput.onchange = handlePdfFile;
            document.getElementById('save-material').onclick = saveMaterial;

            els.btnLoadChoice.onclick = () => { els.choiceModeSelection.style.display = 'none'; els.choiceLoadContainer.style.display = 'block'; };
            els.btnPracticeChoice.onclick = () => { 
                els.choiceModeSelection.style.display = 'none'; 
                els.choicePracticeContainer.style.display = 'block'; 
                if (els.choiceList.innerHTML.includes('italic')) loadChoiceTopics();
            };
            els.backModeChoice1.onclick = () => { els.choiceModeSelection.style.display = 'grid'; els.choiceLoadContainer.style.display = 'none'; };
            els.backModeChoice2.onclick = () => { els.choiceModeSelection.style.display = 'grid'; els.choicePracticeContainer.style.display = 'none'; };
            els.analyzeBtn.onclick = handleAnalyzeChoice;
            els.generateChoiceBtn.onclick = handleGenerateChoice;
            document.getElementById('toggle-sidebar-btn').onclick = toggleFocusMode;
            
            els.studyModeBtn.onclick = () => { 
                els.modeSelection.classList.add('hidden'); 
                els.studyContainer.classList.remove('hidden'); 
                loadSyllabusBrowser(); // Ahora usa la lógica persistente
            };
            els.examModeBtn.onclick = () => { els.modeSelection.classList.add('hidden'); els.examContainer.classList.remove('hidden'); };
            document.getElementById('back-mode-1').onclick = resetModes;
            document.getElementById('back-mode-2').onclick = resetModes;
            document.getElementById('generate-exam-btn').onclick = generateOralExam;

            els.mergeTopicsBtn.onclick = mergeSelectedTopics;
            els.createSubtopicBtn.onclick = createSubtopicFromSelected;

            els.syllabusBrowser.addEventListener('click', (e) => {
                const unitBtn = e.target.closest('.unit-toggle-btn');
                if (unitBtn) {
                    toggleAccordion(unitBtn, unitBtn.nextElementSibling); 
                    return;
                }
                const topicBtn = e.target.closest('.syllabus-topic-btn');
                if (topicBtn) handleStudyTopicSelect(topicBtn);
            });

            document.getElementById('study-output').addEventListener('click', (e) => {
                if (e.target.closest('.answer-btn')) handleAnswerClick(e.target.closest('.answer-btn'));
                 else if (e.target.closest('.audio-btn')) handleAudioClick(e.target.closest('.audio-btn'));
                 else if (e.target.closest('.save-btn')) handleSaveClick(e.target.closest('.save-btn'));
                else if (e.target.closest('.edit-item-btn')) toggleEditItem(e.target.closest('.edit-item-btn'));
                else if (e.target.closest('.generate-more-btn')) handleGenerateMoreQuestions(e.target.closest('.generate-more-btn'));
            });    

            document.getElementById('edit-qa-cancel').onclick = () => els.editQaModal.style.display = 'none';
            document.getElementById('edit-qa-save').onclick = saveEditQa;
            els.confirmNo.onclick = () => els.confirmModal.style.display = 'none';
            document.getElementById('edit-mcq-cancel').onclick = () => els.editMcqModal.style.display = 'none';
            document.getElementById('edit-mcq-save').onclick = saveEditMcq;

            // --- NUEVOS LISTENERS DEL PARCHE 4 ---
            if(els.regenerateSyllabusBtn) els.regenerateSyllabusBtn.onclick = regenerateSyllabus;
            if(els.toggleOrgModeBtn) els.toggleOrgModeBtn.onclick = toggleReviewOrgMode;
            if(els.createContainerBtn) els.createContainerBtn.onclick = createReviewContainer;
                    }
        
            document.getElementById('save-sync-id').onclick = () => {
                const val = document.getElementById('sync-id-input').value.trim();
                if(val) { localStorage.setItem('my_sync_userId', val); location.reload(); }
            };
            document.getElementById('generate-sync-id').onclick = () => {
                localStorage.setItem('my_sync_userId', crypto.randomUUID()); location.reload();
            };
            document.getElementById('change-sync-id').onclick = () => {
                const newId = prompt("Ingresa tu ID de Sincronización. (Dejar en blanco para generar uno nuevo).", userId);
                if (newId === null) return;
                if (newId.trim() === "") localStorage.setItem('my_sync_userId', crypto.randomUUID());
                else localStorage.setItem('my_sync_userId', newId.trim());
                location.reload();
            };
            els.addSubjectBtn.onclick = createSubject;
            els.subjectSelect.onchange = changeSubject;
            document.querySelectorAll('.upload-pdf-btn').forEach(btn => {
                btn.onclick = () => {
                    els.pdfInput.dataset.target = btn.dataset.target;
                    els.pdfInput.click();
                };
            });
            els.pdfInput.onchange = handlePdfFile;
            document.getElementById('save-material').onclick = saveMaterial;

            els.btnLoadChoice.onclick = () => { els.choiceModeSelection.style.display = 'none'; els.choiceLoadContainer.style.display = 'block'; };
            els.btnPracticeChoice.onclick = () => { 
                els.choiceModeSelection.style.display = 'none'; 
                els.choicePracticeContainer.style.display = 'block'; 
                if (els.choiceList.innerHTML.includes('italic')) loadChoiceTopics();
            };
            els.backModeChoice1.onclick = () => { els.choiceModeSelection.style.display = 'grid'; els.choiceLoadContainer.style.display = 'none'; };
            els.backModeChoice2.onclick = () => { els.choiceModeSelection.style.display = 'grid'; els.choicePracticeContainer.style.display = 'none'; };
            els.analyzeBtn.onclick = handleAnalyzeChoice;
            els.generateChoiceBtn.onclick = handleGenerateChoice;
            document.getElementById('toggle-sidebar-btn').onclick = toggleFocusMode;
            
            els.studyModeBtn.onclick = () => { 
                els.modeSelection.classList.add('hidden'); 
                els.studyContainer.classList.remove('hidden'); 
                loadSyllabusBrowser(); 
            };
            els.examModeBtn.onclick = () => { els.modeSelection.classList.add('hidden'); els.examContainer.classList.remove('hidden'); };
            document.getElementById('back-mode-1').onclick = resetModes;
            document.getElementById('back-mode-2').onclick = resetModes;
            document.getElementById('generate-exam-btn').onclick = generateOralExam;

            els.mergeTopicsBtn.onclick = mergeSelectedTopics;
            els.createSubtopicBtn.onclick = createSubtopicFromSelected;

            els.syllabusBrowser.addEventListener('click', (e) => {
                const unitBtn = e.target.closest('.unit-toggle-btn');
                if (unitBtn) {
                    toggleAccordion(unitBtn, unitBtn.nextElementSibling); 
                    return;
                }
                const topicBtn = e.target.closest('.syllabus-topic-btn');
                if (topicBtn) handleStudyTopicSelect(topicBtn);
            });

        document.getElementById('study-output').addEventListener('click', (e) => {
            if (e.target.closest('.answer-btn')) handleAnswerClick(e.target.closest('.answer-btn'));
             else if (e.target.closest('.audio-btn')) handleAudioClick(e.target.closest('.audio-btn')); // <--- NUEVO LISTENER
             else if (e.target.closest('.save-btn')) handleSaveClick(e.target.closest('.save-btn'));
            else if (e.target.closest('.edit-item-btn')) toggleEditItem(e.target.closest('.edit-item-btn'));
            else if (e.target.closest('.generate-more-btn')) handleGenerateMoreQuestions(e.target.closest('.generate-more-btn'));
});    

            document.getElementById('edit-qa-cancel').onclick = () => els.editQaModal.style.display = 'none';
            document.getElementById('edit-qa-save').onclick = saveEditQa;
            els.confirmNo.onclick = () => els.confirmModal.style.display = 'none';
            document.getElementById('edit-mcq-cancel').onclick = () => els.editMcqModal.style.display = 'none';
            document.getElementById('edit-mcq-save').onclick = saveEditMcq;
        }

        // --- PROGRESS UTILS ---
        function showProgress(title, step, pct) {
            els.progressModal.style.display = 'flex';
            els.progressTitle.textContent = title;
            els.progressStep.textContent = step;
            els.progressBarFill.style.width = pct + '%';
        }
        function hideProgress() {
            els.progressModal.style.display = 'none';
        }
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        // --- CORE & LOGIC ---

        function switchTab(tabId) {
            currentTab = tabId;
            els.tabs.forEach(t => t.classList.remove('active'));
            els.panels.forEach(p => p.classList.remove('active'));
            document.getElementById(tabId + '-btn').classList.add('active');
            document.getElementById(tabId).classList.add('active');
            if (currentSubject) loadDataForCurrentTab(tabId);
        }

        async function loadSubjects() {
            try {
                const ref = collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects');
                const snap = await getDocs(ref);
                els.subjectSelect.innerHTML = `<option value="">-- Seleccionar --</option><option value="all">-- Ver Todas --</option>`;
                allSubjectNames = [];
                snap.forEach(d => {
                    allSubjectNames.push(d.id);
                    const opt = document.createElement('option');
                    opt.value = d.id; opt.textContent = d.id;
                    els.subjectSelect.appendChild(opt);
                });
            } catch (error) {
                console.error("Error fatal al cargar materias:", error);
                showError("Error al cargar materias. Revisa los permisos de Firestore.");
                els.subjectHeader.innerHTML = '<p class="text-red-500">Error al cargar materias.</p>';
            }
        }

        async function createSubject() {
            const name = els.newSubjectInput.value.trim();
            if (!name) return;
            try {
                await setDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', name), { created: serverTimestamp() });
                await loadSubjects();
                els.subjectSelect.value = name;
                await changeSubject(); 
            } catch (e) {
                console.error("Error creating subject: ", e);
                showError("Error al crear la materia. Revisa la consola.");
            }
        }

        async function changeSubject() {
            currentSubject = els.subjectSelect.value;
            if (unsubscribeReview) unsubscribeReview();
            if (unsubscribeRoadmap) unsubscribeRoadmap();
            clearAllTabs();
            if (currentSubject && currentSubject !== 'all') {
                showLoadingOnTabs(true, true);
                try {
                    await Promise.all([
                        loadMaterialFields(), loadChoiceTopics(), loadTopicManager(),
                        loadReviewData(currentSubject), loadRoadmapData(currentSubject)
                    ]);
                } catch (error) {
                    console.error("Error al cargar datos:", error);
                    showError("Error al cargar datos de la materia.");
                }
                showLoadingOnTabs(false, true);
            } else if (currentSubject === 'all') {
                showLoadingOnTabs(true, false);
                try { await Promise.all([loadReviewData('all'), loadRoadmapData('all')]); } catch (error) {}
                showLoadingOnTabs(false, false);
            }
        }
        
        function loadDataForCurrentTab(tabId) {
            const subject = currentSubject;
            if (!subject) return;
            if (subject === 'all') {
                if (tabId === 'review') loadReviewData('all');
                if (tabId === 'roadmap') loadRoadmapData('all');
            } else {
                if (tabId === 'material') loadMaterialFields();
                if (tabId === 'choice') loadChoiceTopics();
                if (tabId === 'topics') loadTopicManager();
                if (tabId === 'review') loadReviewData(subject);
                if (tabId === 'roadmap') loadRoadmapData(subject);
            }
        }
        
        function showLoadingOnTabs(isLoading, isFullLoad) {
            const loaders = [els.reviewLoader, els.roadmapLoader];
            if (isFullLoad) loaders.push(els.topicManagerLoader, els.choiceLoaderPractice);
            loaders.forEach(loader => { if (loader) loader.style.display = isLoading ? 'block' : 'none'; });
        }
        
        function clearAllTabs() {
            els.choiceList.innerHTML = '<p class="text-gray-400 italic">Selecciona una materia.</p>';
            els.practiceArea.innerHTML = '<p class="text-gray-400">Selecciona un tema.</p>';
            els.syllabusBrowser.innerHTML = '<p class="text-gray-400">Selecciona una materia.</p>';
            els.reviewList.innerHTML = '<p class="text-gray-400 text-center py-10">Selecciona una materia (o "Ver Todas").</p>';
            els.roadmapList.innerHTML = '<p class="text-gray-400 text-center py-10">Selecciona una materia (o "Ver Todas").</p>';
            els.topicManagerList.innerHTML = '<p class="text-gray-400 text-center py-10">Selecciona una materia.</p>';
            loadMaterialFields(true);
            els.choiceModeSelection.style.display = 'grid';
            els.choiceLoadContainer.style.display = 'none';
            els.choicePracticeContainer.style.display = 'none';
            els.reviewTitle.textContent = "Repaso (SRS)";
            els.reviewSubtitle.textContent = "Selecciona una materia o 'Ver Todas'.";
            els.roadmapTitle.textContent = "Hoja de Ruta";
            els.roadmapSubtitle.textContent = "Selecciona una materia o 'Ver Todas'.";
            showLoadingOnTabs(false, true);
            els.reviewOverdue.style.display = 'none';
        }

        async function handlePdfFile(e) {
            const file = e.target.files[0];
            if(!file) return;
            const targetId = e.target.dataset.target;
            const textarea = document.getElementById(targetId);
            const prevText = textarea.placeholder;
            textarea.placeholder = "Procesando PDF...";
            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                let fullText = "\n\n--- CONTENIDO PDF: " + file.name + " ---\n";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(item => item.str).join(' ') + "\n";
                }
                textarea.value += fullText;
                textarea.placeholder = prevText;
                showError("PDF cargado correctamente (añadido al final del texto).", false);
            } catch(err) {
                console.error(err);
                showError("Error leyendo PDF. Asegúrate de que sea un PDF de texto seleccionable.");
            }
            e.target.value = '';
        }

        // --- SAVE MATERIAL WITH PROGRESS ---
        async function saveMaterial() {
            if (!currentSubject || currentSubject === 'all') return showError("Selecciona una materia específica para guardar.");
            
            showProgress("Guardando Material", "Preparando textos...", 10);
            await sleep(500);

            const data = {
                syllabus: document.getElementById('syllabus').value,
                theory: document.getElementById('theory').value,
                experiences: document.getElementById('experiences').value
            };

            showProgress("Guardando Material", "Subiendo a la base de datos...", 50);
            
            try {
                // Simulamos un guardado paso a paso
                let step = 50;
                for(const [key, val] of Object.entries(data)) {
                    step += 15;
                    showProgress("Guardando Material", `Guardando ${key}...`, step);
                    await setDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'materials', key), { content: val });
                }
                showProgress("Guardando Material", "¡Listo!", 100);
                await sleep(800);
                hideProgress();
                document.getElementById('save-status').textContent = "¡Guardado exitoso!";
                setTimeout(() => document.getElementById('save-status').textContent = '', 3000);
            } catch (e) {
                hideProgress();
                showError("Error al guardar material: " + e.message);
            }
        }

        async function loadMaterialFields(clear = false) {
            if (clear) { ['syllabus', 'theory', 'experiences', 'choice-raw'].forEach(key => { if(document.getElementById(key)) document.getElementById(key).value = ''; }); return; }
            if (!currentSubject || currentSubject === 'all') return;
            for(const key of ['syllabus', 'theory', 'experiences']) {
                try {
                    const d = await getDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'materials', key));
                    document.getElementById(key).value = d.exists() ? d.data().content : '';
                } catch(e) {
                    console.warn(`No se pudo cargar material: ${key}`, e);
                    document.getElementById(key).value = '';
                }
            }
            document.getElementById('choice-raw').value = '';
        }
        
        function chunkText(text, size = 15000) {
            const chunks = [];
            for (let i = 0; i < text.length; i += size) {
                chunks.push(text.substring(i, i + size));
            }
            return chunks;
        }

                // --- LOGICA MODO ORGANIZACIÓN & REPASO (PARCHE 6) ---
        let isOrgMode = false;
        let reviewContainersData = [];

        async function toggleReviewOrgMode() {
            isOrgMode = !isOrgMode;
            const btn = document.getElementById('toggle-org-mode-btn');
            
            if (isOrgMode) {
                // Activar Modo Organización
                btn.innerHTML = `<svg data-lucide="check" class="w-4 h-4"></svg> Finalizar`;
                btn.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
                els.reviewViewMode.classList.add('hidden');
                els.reviewOrgMode.classList.remove('hidden');
                els.reviewOrgMode.style.display = 'grid'; 
                await loadOrgModeData();
            } else {
                // Volver a Modo Vista
                btn.innerHTML = `<svg data-lucide="layout" class="w-4 h-4"></svg> Organizar`;
                btn.classList.remove('bg-green-50', 'text-green-700', 'border-green-200');
                els.reviewOrgMode.classList.add('hidden');
                els.reviewOrgMode.style.display = 'none';
                els.reviewViewMode.classList.remove('hidden');
                loadReviewData(currentSubject); // Recargar para ver los cambios
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function loadOrgModeData() {
            // 1. Cargar configuración de grupos guardada
            reviewContainersData = [];
            try {
                const docRef = doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'materials', 'review_organization');
                const snap = await getDoc(docRef);
                if (snap.exists()) reviewContainersData = snap.data().containers || [];
            } catch(e) { console.log("Sin contenedores previos"); }

            // 2. Obtener TODOS los temas que existen en tus preguntas (Oral y Choice)
            const allTopicsSet = new Set();
            try {
                // Traemos solo metadatos si fuera posible, pero Firestore requiere leer el doc
                const q1 = query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions'));
                const q2 = query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq'));
                
                const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
                
                snap1.forEach(d => { if(d.data().topic) allTopicsSet.add(d.data().topic); });
                snap2.forEach(d => { if(d.data().topic) allTopicsSet.add(d.data().topic); });
            } catch(e) { console.error(e); }
            
            renderOrgMode(Array.from(allTopicsSet));
        }

        function renderOrgMode(allTopics) {
            const poolList = document.getElementById('org-pool-list');
            const containersArea = document.getElementById('org-containers-area');
            poolList.innerHTML = ''; containersArea.innerHTML = '';

            // Identificar temas ya asignados a algún grupo
            const assignedTopics = new Set();
            reviewContainersData.forEach(c => c.topics.forEach(t => assignedTopics.add(t)));

            // A. Renderizar columna izquierda (Temas Sueltos)
            const sortedTopics = allTopics.sort();
            if (sortedTopics.length === 0) {
                poolList.innerHTML = '<p class="text-gray-400 text-sm p-2">No hay temas creados aún.</p>';
            } else {
                sortedTopics.forEach(topic => {
                    // Solo mostramos si NO está asignado a un grupo
                    if (!assignedTopics.has(topic)) {
                        poolList.appendChild(createDraggableElement(topic, 'topic'));
                    }
                });
            }

            // B. Renderizar columna derecha (Contenedores)
            reviewContainersData.forEach((container, idx) => {
                const div = document.createElement('div');
                div.className = 'org-container relative';
                // Header del contenedor
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <span class="font-bold text-blue-800 flex items-center gap-2">
                            <svg data-lucide="folder" class="w-4 h-4 text-blue-400"></svg> ${container.name}
                        </span>
                        <button class="text-red-400 hover:text-red-600 p-1" onclick="deleteContainer(${idx})" title="Eliminar Grupo">
                            <svg data-lucide="trash-2" class="w-4 h-4"></svg>
                        </button>
                    </div>
                    <div class="org-drop-zone min-h-[50px] space-y-2" data-container-idx="${idx}"></div>
                `;
                
                const dropZone = div.querySelector('.org-drop-zone');
                
                // Renderizar temas DENTRO del contenedor
                container.topics.forEach(topic => {
                    dropZone.appendChild(createDraggableElement(topic, 'topic-in-container'));
                });

                // Configurar eventos de Drop
                setupDropZone(dropZone, idx);
                containersArea.appendChild(div);
            });

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function createDraggableElement(text, type) {
            const div = document.createElement('div');
            div.className = 'org-topic-item';
            div.draggable = true;
            div.dataset.topic = text;
            div.innerHTML = `<span class="text-sm font-medium text-gray-700">${text}</span> <svg data-lucide="grip-vertical" class="w-4 h-4 text-gray-300"></svg>`;
            
            div.ondragstart = (e) => {
                e.dataTransfer.setData('text/plain', text);
                // Guardamos referencia global temporal para efectos visuales
                window.draggedElement = div; 
                div.classList.add('dragging');
            };
            div.ondragend = () => {
                div.classList.remove('dragging');
                window.draggedElement = null;
            };
            return div;
        }

        function setupDropZone(el, containerIdx) {
            el.ondragover = (e) => { e.preventDefault(); el.parentElement.classList.add('drag-over'); };
            el.ondragleave = () => { el.parentElement.classList.remove('drag-over'); };
            
            el.ondrop = async (e) => {
                e.preventDefault();
                el.parentElement.classList.remove('drag-over');
                const topic = e.dataTransfer.getData('text/plain');
                
                // Lógica de movimiento:
                // 1. Buscar y quitar el tema de cualquier otro contenedor donde estuviera
                reviewContainersData.forEach(c => {
                    c.topics = c.topics.filter(t => t !== topic);
                });
                
                // 2. Agregarlo a ESTE contenedor (evitando duplicados)
                if (!reviewContainersData[containerIdx].topics.includes(topic)) {
                    reviewContainersData[containerIdx].topics.push(topic);
                }

                // 3. Guardar y refrescar UI
                await saveReviewOrganization();
                await loadOrgModeData(); 
            };
        }

        async function createReviewContainer() {
            const name = els.newContainerInput.value.trim();
            if (!name) return;
            // Agregar nuevo grupo vacío
            reviewContainersData.push({ name: name, topics: [] });
            els.newContainerInput.value = '';
            await saveReviewOrganization();
            await loadOrgModeData();
        }

        async function deleteContainer(idx) {
            if(!confirm("¿Eliminar este grupo? Los temas volverán a la lista de 'Disponibles'.")) return;
            reviewContainersData.splice(idx, 1);
            await saveReviewOrganization();
            await loadOrgModeData();
        }

        async function saveReviewOrganization() {
            try {
                await setDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'materials', 'review_organization'), { 
                    containers: reviewContainersData 
                }, { merge: true });
            } catch(e) { console.error("Error guardando organización", e); }
        }

        // --- NUEVA VERSIÓN DE LOADREVIEWDATA (REEMPLAZA A LA ANTERIOR) ---
        async function loadReviewData(subject) {
            els.reviewLoader.style.display = 'block';
            
            // Limpiar UI
            if(els.reviewContainersList) els.reviewContainersList.innerHTML = '';
            els.reviewList.innerHTML = '';
            els.reviewOverdue.style.display = 'none';

            // Títulos
            if (subject === 'all') {
                els.reviewTitle.textContent = "Repaso Global";
                els.reviewSubtitle.textContent = "Todas tus materias.";
            } else {
                els.reviewTitle.textContent = `Repaso: ${subject}`;
                els.reviewSubtitle.textContent = "Modo Organizado";
            }

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let allDueCards = []; // Todas las tarjetas que tocan hoy (o vencidas)
            let allCardsTotal = []; // Para calcular el progreso (mastered vs total)

            try {
                const subjectsToQuery = (subject === 'all') ? allSubjectNames : [subject];
                
                // 1. Obtener tarjetas (Vencidas y Totales para calcular progreso)
                for (const subj of subjectsToQuery) {
                    const q = query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', subj, 'saved_questions'));
                    const snap = await getDocs(q);
                    snap.forEach(d => {
                        const data = { id: d.id, subject: subj, ...d.data() };
                        allCardsTotal.push(data); // Todas (para la barra de progreso)
                        
                        // Filtrar solo las que tocan hoy para "Repasar"
                        if (data.nextReviewDate && data.nextReviewDate.toDate() <= now) {
                            allDueCards.push(data);
                        }
                    });
                }

                els.reviewLoader.style.display = 'none';
                els.reviewCount.textContent = allDueCards.length;

                // Aviso de vencidas
                const overdueCount = allDueCards.filter(c => c.nextReviewDate.toDate() < today).length;
                if (overdueCount > 0) {
                    els.reviewOverdue.textContent = `Tienes ${overdueCount} tarjetas atrasadas.`;
                    els.reviewOverdue.style.display = 'block';
                }

                // 2. Cargar Organización de Grupos
                let containers = [];
                if (subject !== 'all') {
                    try {
                        const orgSnap = await getDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', subject, 'materials', 'review_organization'));
                        if (orgSnap.exists()) containers = orgSnap.data().containers || [];
                    } catch(e) {}
                }

                // 3. Renderizar Grupos (Contenedores)
                if (containers.length > 0 && els.reviewContainersList) {
                    containers.forEach(cont => {
                        // Filtrar tarjetas que pertenecen a este grupo
                        // A. Para calcular progreso (todas las del tema)
                        const groupCardsTotal = allCardsTotal.filter(c => cont.topics.includes(c.topic));
                        // B. Para repasar hoy (solo vencidas)
                        const groupCardsDue = allDueCards.filter(c => cont.topics.includes(c.topic));

                        // Calculo Progreso: (Tarjetas con reviewStep > 0) / Total
                        const learnedCards = groupCardsTotal.filter(c => c.reviewStep > 0).length;
                        const totalGroup = groupCardsTotal.length;
                        const progress = totalGroup > 0 ? Math.round((learnedCards / totalGroup) * 100) : 0;

                        const div = document.createElement('div');
                        div.className = 'review-group-card';
                        div.innerHTML = `
                            <div class="review-group-header" onclick="this.parentElement.classList.toggle('expanded')">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                        <svg data-lucide="folder-open" class="w-5 h-5 text-blue-500"></svg> ${cont.name}
                                    </span>
                                    ${groupCardsDue.length > 0 
                                        ? `<span class="text-xs font-bold px-3 py-1 rounded-full bg-red-100 text-red-600 shadow-sm animate-pulse">${groupCardsDue.length} para hoy</span>` 
                                        : `<span class="text-xs font-bold px-3 py-1 rounded-full bg-green-100 text-green-600 shadow-sm"><svg data-lucide="check" class="w-3 h-3 inline"></svg> Al día</span>`
                                    }
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-2 px-1">
                                    <span>${cont.topics.length} temas</span>
                                    <span>Dominio: ${progress}%</span>
                                </div>
                                <div class="group-progress-bg">
                                    <div class="group-progress-fill" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <div class="review-group-body">
                                ${groupCardsDue.length > 0 ? 
                                    `<button class="w-full py-3 mb-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition-all flex justify-center items-center gap-2"
                                        onclick="startAnkiSessionFromGroup(['${cont.topics.join("','")}'])">
                                        <svg data-lucide="play" class="w-4 h-4 fill-current"></svg> Repasar Grupo (${groupCardsDue.length})
                                    </button>` 
                                    : `<p class="text-center text-gray-400 text-sm mb-4 italic">No hay tarjetas pendientes en este grupo.</p>`
                                }
                                
                                <div class="space-y-1 border-t pt-2">
                                    <p class="text-xs font-bold text-gray-400 uppercase mb-2">Temas en este grupo:</p>
                                    ${cont.topics.map(topic => {
                                        const tDue = groupCardsDue.filter(c => c.topic === topic).length;
                                        return `
                                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded border border-gray-100 text-sm">
                                                <span class="text-gray-700">${topic}</span>
                                                ${tDue > 0 ? `<span class="text-red-500 font-bold text-xs">${tDue}</span>` : `<svg data-lucide="check-circle" class="w-3 h-3 text-green-400"></svg>`}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                        els.reviewContainersList.appendChild(div);
                    });
                }

                // 4. Renderizar Temas Sueltos (Lo que no está en contenedores)
                const assignedTopics = new Set();
                containers.forEach(c => c.topics.forEach(t => assignedTopics.add(t)));
                
                const looseCards = allDueCards.filter(c => !assignedTopics.has(c.topic));
                
                // Usamos la lógica antigua de renderizado para los sueltos
                renderReviewCards(looseCards, subject === 'all');

            } catch (error) {
                console.error("Error cargando repasos:", error);
                els.reviewList.innerHTML = '<p class="text-red-500">Error al cargar datos.</p>';
            }
        }

        // Helper para iniciar sesión filtrada por temas
        async function startAnkiSessionFromGroup(topicsArray) {
            // Reutilizamos lógica: buscamos las cartas de estos temas que venzan hoy
            const now = new Date();
            let cardsToPlay = [];
            
            try {
                // Nota: Firestore "in" soporta max 10 items. Si un grupo tiene más de 10 temas,
                // es más seguro traer todo y filtrar en JS (ya tenemos caché parcial, pero por seguridad hacemos query simple)
                const q = query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions'));
                const snap = await getDocs(q);
                
                snap.forEach(d => {
                    const data = { id: d.id, ...d.data() };
                    // Si el tema está en la lista Y vence hoy
                    if (topicsArray.includes(data.topic) && data.nextReviewDate && data.nextReviewDate.toDate() <= now) {
                        cardsToPlay.push(data);
                    }
                });

                if (cardsToPlay.length === 0) { alert("¡Ya repasaste todo en este grupo!"); return; }

                // Usamos un contenedor temporal modal o el mismo div de review
                // Ocultamos la lista y mostramos la zona de práctica (reutilizando roadmapPractice por comodidad)
                els.reviewViewMode.classList.add('hidden');
                els.reviewOrgMode.classList.add('hidden'); // Asegurar oculto
                
                // Creamos un contenedor temporal si no existe
                let practiceContainer = document.getElementById('group-practice-session');
                if(!practiceContainer) {
                    practiceContainer = document.createElement('div');
                    practiceContainer.id = 'group-practice-session';
                    els.reviewList.parentNode.appendChild(practiceContainer);
                }
                practiceContainer.style.display = 'block';
                practiceContainer.innerHTML = '';

                // Iniciar sesión
                startAnkiSession(cardsToPlay, practiceContainer, () => {
                    practiceContainer.style.display = 'none';
                    els.reviewViewMode.classList.remove('hidden');
                    loadReviewData(currentSubject); // Recargar al terminar
                });

            } catch(e) { console.error(e); alert("Error al iniciar grupo."); }
        }

        async function loadRoadmapData(subject) {
            els.roadmapLoader.style.display = 'block';
            els.roadmapList.innerHTML = '';
            els.roadmapPractice.innerHTML = '';
            els.roadmapPractice.style.display = 'none';
            if (subject === 'all') {
                els.roadmapTitle.textContent = "Hoja de Ruta Global";
                els.roadmapSubtitle.textContent = "Próximos repasos de todas tus materias.";
            } else {
                els.roadmapTitle.textContent = `Hoja de Ruta - ${subject}`;
                els.roadmapSubtitle.textContent = "Próximos repasos para esta materia.";
            }
            const now = new Date();
            let allFutureCards = [];
            try {
                const subjectsToQuery = (subject === 'all') ? allSubjectNames : [subject];
                for (const subj of subjectsToQuery) {
                    const q = query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', subj, 'saved_questions'), where('nextReviewDate', '>', now));
                    const snap = await getDocs(q);
                    snap.forEach(d => { allFutureCards.push({ id: d.id, subject: subj, ...d.data() }); });
                }
                els.roadmapLoader.style.display = 'none';
                if (allFutureCards.length === 0) { els.roadmapList.innerHTML = '<p class="text-gray-400">No hay repasos futuros.</p>'; return; }
                allFutureCards.sort((a,b) => a.nextReviewDate.toMillis() - b.nextReviewDate.toMillis());
                const groupedByDay = allFutureCards.reduce((acc, card) => {
                    const date = card.nextReviewDate.toDate().toLocaleDateString();
                    if (!acc[date]) acc[date] = []; acc[date].push(card); return acc;
                }, {});
                renderRoadmapAccordions(groupedByDay, subject === 'all');
            } catch (error) {
                console.error("Error cargando hoja de ruta:", error);
                els.roadmapLoader.style.display = 'none';
                els.roadmapList.innerHTML = '<p class="text-red-500">Error al cargar la hoja de ruta.</p>';
            }
        }

        async function handleAnalyzeChoice() {
            const rawText = els.choiceRaw.value;
            if (!rawText.trim()) return showError("No hay texto de examen para analizar.");
            if (!currentSubject || currentSubject === 'all') return showError("Selecciona una materia específica.");
            
            els.analyzeBtn.disabled = true;
            // Usar Overlay en lugar del loader pequeño
            showProgress("Analizando Examen", "Preparando fragmentos...", 10);
            
            try {
                const syllabus = document.getElementById('syllabus').value;
                const theory = document.getElementById('theory').value;
                const experiences = document.getElementById('experiences').value;
                
                // Smart Context Construction
                // PRIORIDAD: Experiencias > Syllabus > Teoría
                // Aumentamos límite a 50k caracteres para análisis
                const smartContext = buildSmartContext(syllabus, theory, experiences, 50000, 'exam');

                const textChunks = chunkText(rawText);
                let allParsedQuestions = [];
                
                for (let i = 0; i < textChunks.length; i++) {
                    const pct = 10 + Math.round(((i+1) / textChunks.length) * 60);
                    showProgress("Analizando Examen", `Procesando parte ${i + 1} de ${textChunks.length} con IA...`, pct);
                    
                    const chunk = textChunks[i];
                    // Pasamos smartContext como un objeto simulado o string concatenado
                    // Modificaremos callGeminiForChoice para aceptar string directo o armarlo
                    const parsedQuestions = await callGeminiForChoice(chunk, smartContext);
                    allParsedQuestions = allParsedQuestions.concat(parsedQuestions);
                }
                
                showProgress("Analizando Examen", `Guardando ${allParsedQuestions.length} preguntas...`, 90);

                const batch = writeBatch(db);
                allParsedQuestions.forEach(q => {
                    const docRef = doc(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq'));
                    batch.set(docRef, { ...q, createdAt: serverTimestamp(), status: 'new', isVerified: false });
                });
                await batch.commit();
                
                els.choiceRaw.value = '';
                showProgress("Analizando Examen", "¡Completado!", 100);
                await sleep(800);
                hideProgress();

                showError(`¡Éxito! Se clasificaron ${allParsedQuestions.length} preguntas.`, false);
                await loadChoiceTopics();
                els.choiceLoadContainer.style.display = 'none'; els.choicePracticeContainer.style.display = 'block';
            } catch (err) {
                hideProgress();
                console.error(err);
                showError("Error al analizar: " + err.message);
            } finally {
                els.analyzeBtn.disabled = false;
            }
        }
        
        async function handleGenerateChoice() {
            if (!currentSubject || currentSubject === 'all') return showError("Selecciona una materia específica.");
            
            const qty = els.generateChoiceQty.value;
            els.generateChoiceBtn.disabled = true;
            showProgress("Generando Preguntas", "Consultando a la IA...", 30);

            try {
                const syllabus = document.getElementById('syllabus').value;
                const theory = document.getElementById('theory').value;
                const experiences = document.getElementById('experiences').value;

                if (!syllabus.trim() && !theory.trim() && !experiences.trim()) throw new Error("El material está vacío.");
                
                // Usamos 300k de contexto
                const contextMaterial = buildSmartContext(syllabus, theory, experiences, 300000, 'exam');

                const prompt = `
                    Basado en el siguiente material (Prioriza lo que se toma en exámenes):
                    ${contextMaterial}
                    
                    Genera exactamente ${qty} preguntas de opción múltiple (Choice).
                    IMPORTANTE: Si hay experiencias de examen, basa las preguntas en esos temas.
                    Para CADA pregunta, asigna un 'topic' y 'unit'. 
                    Opciones: 4 o 5. Justificación clara.
                    Responde SOLO con un JSON Array: [{ "question": "...", "options": ["A", "B", "C", "D", "E"], "correctIndex": 0, "topic": "...", "unit": "...", "justification": "..." }]
                `;
                
                let txt = await callGeminiAPI(prompt, true);
                
                showProgress("Generando Preguntas", "Procesando respuesta...", 80);
                const generatedQuestions = parseJsonFromAi(txt);
                
                const batch = writeBatch(db);
                generatedQuestions.forEach(q => {
                    const docRef = doc(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq'));
                    batch.set(docRef, { ...q, createdAt: serverTimestamp(), status: 'new', isVerified: true });
                });
                await batch.commit();

                showProgress("Generando Preguntas", "¡Listo!", 100);
                await sleep(500);
                hideProgress();

                showError(`¡Éxito! Se generaron ${generatedQuestions.length} preguntas.`, false);
                await loadChoiceTopics();
                els.choiceLoadContainer.style.display = 'none'; els.choicePracticeContainer.style.display = 'block';
            } catch (err) {
                hideProgress();
                console.error(err);
                showError("Error al generar preguntas: " + err.message);
            } finally {
                els.generateChoiceBtn.disabled = false; 
            }
        }

        function parseJsonFromAi(txt) {
            try {
                txt = txt.replace(/\\\[/g, '[').replace(/\\\]/g, ']');
                const jsonMatch = txt.match(/\[\s*\{.*\}\s*\]/s);
                let jsonToParse = (jsonMatch && jsonMatch[0]) ? jsonMatch[0] : txt;
                return JSON.parse(jsonToParse);
            } catch (e) {
                console.error("Falló el parseo de JSON:", e, txt);
                throw new Error("La IA devolvió un JSON malformado.");
            }
        }

        async function callGeminiForChoice(examText, contextMaterial) {
            // contextMaterial ya viene construido con prioridades
            const prompt = `
                Analiza este examen Choice.
                CONTEXTO DEL ESTUDIANTE:
                ${contextMaterial}
                
                TEXTO DEL EXAMEN A ANALIZAR:
                ${examText}
                
                Tarea: Extrae preguntas, todas las opciones (pueden ser 4, 5 o más), 'topic', 'unit', y 'justification'.
                IMPORTANTE: Deduce cuál es la respuesta correcta y devuélvela como 'correctIndex' (un número, ej: 0, 1, 2...).
                Responde SOLO un JSON Array: [{ "question": "...", "options": ["A", "B", "C", "D", "E"], "correctIndex": 0, "topic": "...", "unit": "...", "justification": "..." }]
            `;
            let txt = await callGeminiAPI(prompt, true);
            return parseJsonFromAi(txt);
        }

        async function loadChoiceTopics() {
            if (!currentSubject || currentSubject === 'all') { els.choiceList.innerHTML = '<p class="text-sm text-gray-400 italic">Selecciona una materia.</p>'; return; }
            els.choiceLoaderPractice.style.display = 'block';
            els.choiceList.innerHTML = '';
            const q = query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq'));
            const snap = await getDocs(q);
            cachedMcqs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            const topics = {};
            cachedMcqs.forEach(m => {
                const topicName = m.topic || "Sin Clasificar";
                if(!topics[topicName]) topics[topicName] = { total: 0, mastered: 0, name: topicName, questions: [] };
                topics[topicName].total++; topics[topicName].questions.push(m);
                if(m.status === 'mastered') topics[topicName].mastered++;
            });
            els.choiceLoaderPractice.style.display = 'none';
            if (Object.keys(topics).length === 0) { els.choiceList.innerHTML = '<p class="text-sm text-gray-400 italic">No hay preguntas aún.</p>'; return; }
            allPracticeTopicNames = Object.values(topics).sort((a,b) => a.name.localeCompare(b.name));
            allPracticeTopicNames.forEach(t => {
                const pct = Math.round((t.mastered / t.total) * 100);
                const div = document.createElement('div');
                div.className = 'p-3 bg-white border rounded hover:bg-gray-50 cursor-pointer transition';
                div.innerHTML = `<div class="flex justify-between mb-1"><span class="font-bold text-sm">${t.name}</span><span class="text-xs text-gray-500">${t.mastered}/${t.total}</span></div><div class="progress-bar-container h-2"><div class="progress-bar-fill" style="width: ${pct}%"></div></div>`;
                div.onclick = () => showPracticeModeMenu(t.name);
                els.choiceList.appendChild(div);
            });
        }

        function showPracticeModeMenu(topicName) {
            currentPracticeTopic = topicName;
            els.practiceArea.innerHTML = `<div class="practice-mode-menu max-w-md mx-auto"><h3 class="text-lg font-bold text-center mb-2">Practicar: ${topicName}</h3><button class="practice-mode-btn" onclick="startPracticeSession('${topicName}', 'inicial')">Modo Inicial<span>Incluye explicaciones.</span></button><button class="practice-mode-btn" onclick="startPracticeSession('${topicName}', 'normal')">Modo Normal<span>Sin ayudas.</span></button></div>`;
            window.startPracticeSession = startPracticeSession;
        }

        function startPracticeSession(topic, mode) {
            currentPracticeMode = mode;
            currentPracticeQuestions = cachedMcqs.filter(m => (m.topic || "Sin Clasificar") === topic && m.status !== 'mastered');
            if(currentPracticeQuestions.length === 0) currentPracticeQuestions = cachedMcqs.filter(m => (m.topic || "Sin Clasificar") === topic);
            currentPracticeQuestions.sort(() => Math.random() - 0.5);
            currentQuestionIndex = 0; currentQuizCorrect = 0; currentQuizWrong = 0; currentQuizWrongCards = [];
            renderQuestion();
        }

        function renderQuestion() {
            if(currentQuestionIndex >= currentPracticeQuestions.length) {
                const total = currentPracticeQuestions.length;
                const score = currentQuizCorrect;
                const pct = total > 0 ? Math.round((score / total) * 100) : 0;
                els.practiceArea.innerHTML = `<div class="text-center p-6"><svg data-lucide="trophy" class="w-16 h-16 text-yellow-500 mx-auto mb-4"></svg><h3 class="text-2xl font-bold">¡Tema Completado!</h3><p class="text-xl text-gray-600 mt-2">Tu puntaje: <b class="text-blue-600">${score} / ${total} (${pct}%)</b></p><div class="mt-6 flex flex-wrap justify-center gap-3"><button id="choice-back" class="px-5 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Volver</button><button id="choice-retry" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Reintentar</button></div></div>`;
                document.getElementById('choice-back').onclick = () => { els.practiceArea.innerHTML = ''; showPracticeModeMenu(currentPracticeTopic); };
                document.getElementById('choice-retry').onclick = () => startPracticeSession(currentPracticeTopic, currentPracticeMode);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                loadChoiceTopics();
                return;
            }
            isFlashcardCreated = false;
            const q = currentPracticeQuestions[currentQuestionIndex];
            const options = Array.isArray(q.options) ? q.options : [q.options];
            let justificationHtml = '';
            if (currentPracticeMode === 'inicial') {
                justificationHtml = `<div class="mt-4"><button class="justification-accordion-btn" id="justification-btn" aria-expanded="false"><span>Ver Explicación</span><svg data-lucide="chevron-down" class="w-4 h-4"></svg></button><div class="justification-content" id="justification-content">${q.justification ? q.justification : '<p class="text-gray-400 italic">No hay justificación. <a href="#" id="generate-justification-link" class="text-blue-600">Generar</a></p>'}</div></div>`;
            }
            els.practiceArea.innerHTML = `<div class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-left"><div class="flex justify-between text-xs text-gray-400 mb-2"><span>${q.topic || "Sin Clasificar"}</span><span>Pregunta ${currentQuestionIndex + 1} de ${currentPracticeQuestions.length}</span></div><h3 class="text-lg font-bold text-gray-800 mb-6">${q.question}</h3><div id="mcq-options">${options.map((opt, i) => `<div class="mcq-option" data-index="${i}" onclick="selectOption(this, '${String(opt).replace(/'/g, "\\'")}')">${opt}</div>`).join('')}</div><div class="mt-6 flex justify-between items-center"><div class="flex flex-wrap gap-4"><button id="edit-mcq-btn" class="text-sm text-gray-600 font-semibold flex items-center hover:underline"><svg data-lucide="pencil" class="w-4 h-4 mr-1"></svg> Editar</button><button id="anki-plus-btn" class="text-sm text-blue-600 font-semibold flex items-center hover:underline"><svg data-lucide="plus-square" class="w-4 h-4 mr-1"></svg> Crear Flashcard</button><button id="hint-btn" class="text-sm text-yellow-600 font-semibold flex items-center hover:underline"><svg data-lucide="lightbulb" class="w-4 h-4 mr-1"></svg> Pedir Pista</button><button id="verify-ai-btn" class="text-sm text-indigo-600 font-semibold flex items-center hover:underline" style="display: none;"><svg data-lucide="shield-check" class="w-4 h-4 mr-1"></svg> Doble Check IA <div class="loader w-4 h-4 ml-2 border-2 border-indigo-200 border-t-indigo-600" style="display: none; animation: spin 1s linear infinite;"></div></button></div><button id="next-q-btn" class="px-6 py-2 bg-gray-200 text-gray-400 font-bold rounded cursor-not-allowed" disabled>Siguiente</button></div><div id="hint-box" class="hint-box"></div>${justificationHtml}<div id="flashcard-feedback" class="flashcard-feedback"></div></div>`;
            
            document.getElementById('edit-mcq-btn').onclick = () => openEditMcqModal(q);
            document.getElementById('hint-btn').onclick = () => getHint(q);
            document.getElementById('anki-plus-btn').onclick = () => createFlashcardManually(q);
            document.getElementById('next-q-btn').onclick = () => { currentQuestionIndex++; renderQuestion(); };
            const verifyBtn = document.getElementById('verify-ai-btn');
            if (!q.isVerified) verifyBtn.onclick = () => verifyAnswerWithAI(q, verifyBtn);

            if (currentPracticeMode === 'inicial') {
                const justBtn = document.getElementById('justification-btn');
                const justContent = document.getElementById('justification-content');
                if(justBtn) justBtn.onclick = () => toggleAccordion(justBtn, justContent);
                const genLink = document.getElementById('generate-justification-link');
                if(genLink) genLink.onclick = async (e) => {
                    e.preventDefault();
                    justContent.innerHTML = '<div class="loader w-4 h-4"></div>';
                    const newJustification = await getJustificationFromAI(q);
                    q.justification = newJustification; 
                    justContent.innerHTML = newJustification;
                    updateDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq', q.id), { justification: newJustification });
                };
            }
            window.selectOption = (el, text) => checkAnswer(el, text, q);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function getHint(questionData) {
            const box = document.getElementById('hint-box');
            box.style.display = 'block'; box.textContent = "Generando pista...";
            const prompt = `Dame una pista corta para esta pregunta sin dar la respuesta: "${questionData.question}". Opciones: ${questionData.options.join(',')}`;
            const hint = await callGeminiAPI(prompt, false);
            box.textContent = "💡 Pista: " + hint;
        }

        async function getJustificationFromAI(qData) {
             const prompt = `Contexto: Pregunta: "${qData.question}" Opciones: ${qData.options.join(", ")} Respuesta Correcta: ${qData.options[qData.correctIndex] || qData.correctAnswer} Tarea: Escribe una justificación clara.`;
            return await callGeminiAPI(prompt, false);
        }

        async function checkAnswer(el, selectedText, qData) {
            document.querySelectorAll('.mcq-option').forEach(o => { o.style.pointerEvents = 'none'; if (o === el) o.classList.add('selected'); });
            const selectedIndex = parseInt(el.dataset.index, 10);
            let isCorrect, correctIndex;
            if (qData.correctIndex !== undefined) {
                isCorrect = (selectedIndex === qData.correctIndex);
                correctIndex = qData.correctIndex;
            } else {
                isCorrect = selectedText.trim() === String(qData.correctAnswer).trim();
                correctIndex = qData.options.findIndex(opt => String(opt).trim() === String(qData.correctAnswer).trim());
            }
            if (isCorrect) {
                el.classList.add('correct'); currentQuizCorrect++;
                if (qData.status !== 'mastered') {
                    await updateDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq', qData.id), { status: 'mastered' });
                    qData.status = 'mastered';
                }
            } else {
                el.classList.add('incorrect'); currentQuizWrong++;
                if (correctIndex > -1) document.querySelector(`.mcq-option[data-index="${correctIndex}"]`).classList.add('correct');
            }
            const justBtn = document.getElementById('justification-btn');
            if (justBtn && justBtn.getAttribute('aria-expanded') === 'false') toggleAccordion(justBtn, document.getElementById('justification-content'));
            const nextBtn = document.getElementById('next-q-btn');
            nextBtn.disabled = false; nextBtn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed'); nextBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            const verifyBtn = document.getElementById('verify-ai-btn');
            if (verifyBtn && !qData.isVerified) verifyBtn.style.display = 'flex';
        }
        
        async function verifyAnswerWithAI(qData, buttonEl) {
            const loader = buttonEl.querySelector('.loader'); buttonEl.disabled = true; loader.style.display = 'block';
            const genericPrompt = `Doble Verificación de Experto! Contexto Teoría: ${document.getElementById('theory').value.substring(0, 5000)} Pregunta: "${qData.question}" Opciones: ${qData.options.map((o,i)=>i+': '+o).join(', ')} ¿Cuál es el índice de la opción correcta? Responde SOLO con el número.`;
            try {
                const aiResponse = await callGeminiAPI(genericPrompt, false);
                const newCorrectIndex = parseInt(aiResponse.trim(), 10);
                if (isNaN(newCorrectIndex) || newCorrectIndex < 0) throw new Error(`Respuesta inválida: "${aiResponse}"`);
                const docRef = doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq', qData.id);
                if (newCorrectIndex === qData.correctIndex) {
                    await updateDoc(docRef, { isVerified: true });
                    showError("¡Verificado! La IA confirma la respuesta.", false);
                } else {
                    await updateDoc(docRef, { correctIndex: newCorrectIndex, correctAnswer: qData.options[newCorrectIndex], isVerified: true });
                    qData.correctIndex = newCorrectIndex; qData.isVerified = true;
                    showError("¡Corrección Aplicada! La IA actualizó la respuesta.", false);
                    document.querySelectorAll('.mcq-option').forEach(opt => {
                        opt.classList.remove('correct', 'incorrect');
                        const optIndex = parseInt(opt.dataset.index, 10);
                        if (optIndex === newCorrectIndex) opt.classList.add('correct');
                        if (opt.classList.contains('selected') && optIndex !== newCorrectIndex) opt.classList.add('incorrect');
                    });
                }
                buttonEl.style.display = 'none';
            } catch (err) {
                console.error(err); showError("Error al verificar: " + err.message); buttonEl.disabled = false;
            } finally { loader.style.display = 'none'; }
        }
        
        async function createFlashcardManually(qData, isFromError = false) {
            if (isFlashcardCreated && !isFromError) return;
            isFlashcardCreated = true;
             const cardData = {
                id: '', subject: currentSubject, question: qData.question,
                answer: `<b>Respuesta Correcta:</b> ${qData.correctAnswer}<br><br><b>Justificación:</b> ${qData.justification || "Sin justificación."}`,
                imageUrl: '', unit: qData.unit || "Choice", topic: qData.topic || "Sin Clasificar"
            };
            openEditModal(cardData, true);
            const feedback = document.getElementById('flashcard-feedback');
            feedback.textContent = isFromError ? '¡Error! Abriendo editor...' : 'Editor abierto...';
            feedback.style.display = 'block';
            if (!isFromError) document.getElementById('anki-plus-btn').style.display = 'none';
        }
        
        function startAnkiSession(cards, container, onFinish) {
            let currentCardIndex = 0;
            const originalCards = [...cards];
            function renderNextCard() {
                container.innerHTML = '';
                if (currentCardIndex >= originalCards.length) { container.innerHTML = '<p class="text-green-600 font-bold p-4 text-center">¡Sesión completada!</p>'; if (onFinish) onFinish(); return; }
                const card = originalCards[currentCardIndex];
                const div = document.createElement('div');
                div.className = 'qa-card border border-blue-300 shadow-lg';
                let imageHtml = card.imageUrl ? `<img src="${card.imageUrl}" alt="Imagen" class="mt-2 rounded-md max-h-60 object-contain">` : '';
                div.innerHTML = `<p class="font-bold text-gray-800 mb-2">${card.question}</p>${imageHtml}<div class="answer hidden mt-2 p-3 bg-gray-50 rounded border-l-4 border-blue-500 text-sm text-gray-700">${card.answer}</div><div class="controls mt-3 flex justify-between items-center"><button class="show-ans-btn text-blue-600 text-sm font-bold">Mostrar Respuesta</button><div class="rating-btns hidden gap-2"><button class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold" data-rate="hard">Difícil</button><button class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold" data-rate="good">Bien</button><button class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold" data-rate="easy">Fácil</button></div></div><button class="edit-qa-btn !top-auto bottom-3 right-3"><svg data-lucide="pencil" class="w-4 h-4"></svg></button>`;
                const ansDiv = div.querySelector('.answer');
                const controlsDiv = div.querySelector('.rating-btns');
                const showBtn = div.querySelector('.show-ans-btn');
                showBtn.onclick = () => { ansDiv.classList.remove('hidden'); controlsDiv.classList.remove('hidden'); showBtn.classList.add('hidden'); };
                div.querySelectorAll('[data-rate]').forEach(btn => { btn.onclick = async () => { await processSRS(card, btn.dataset.rate); currentCardIndex++; renderNextCard(); }; });
                div.querySelector('.edit-qa-btn').onclick = (e) => { e.stopPropagation(); openEditModal(card); };
                container.appendChild(div);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            renderNextCard();
        }

        function renderReviewCards(cards, isGlobal) {
            els.reviewList.innerHTML = '';
            if (cards.length === 0) { els.reviewList.innerHTML = '<div class="text-center py-10 text-green-600 font-bold bg-green-50 rounded">¡Todo al día!</div>'; return; }
            const groupKey = isGlobal ? 'subject' : 'topic';
            const groupedCards = cards.reduce((acc, card) => {
                const name = card[groupKey] || (isGlobal ? "Sin Materia" : "Sin Clasificar");
                if (!acc[name]) acc[name] = []; acc[name].push(card); return acc;
            }, {});
            for (const groupName in groupedCards) {
                const groupCards = groupedCards[groupName];
                const btn = document.createElement('button');
                btn.className = 'accordion-btn';
                btn.innerHTML = `<span>${groupName} (${groupCards.length} tarjetas)</span><span class="toggle-icon" data-lucide="chevron-down"></span>`;
                const content = document.createElement('div');
                content.className = 'accordion-content p-4';
                const practiceBtn = document.createElement('button');
                practiceBtn.className = 'px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg text-sm hover:bg-blue-700';
                practiceBtn.textContent = 'Empezar Repaso';
                practiceBtn.onclick = (e) => { e.stopPropagation(); startAnkiSession(groupCards, content, () => { loadReviewData(currentSubject); }); };
                content.appendChild(practiceBtn);
                btn.onclick = () => toggleAccordion(btn, content); 
                els.reviewList.appendChild(btn); els.reviewList.appendChild(content);
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function processSRS(card, rating) {
            let nextDate = new Date();
            let nextStep = card.reviewStep || 0;
            if (rating === 'hard') { nextStep = 0; nextDate.setMinutes(nextDate.getMinutes() + 10); } 
            else { const days = rating === 'easy' ? (nextStep === 0 ? 3 : nextStep * 2.5) : (nextStep === 0 ? 1 : nextStep * 1.5); nextDate.setDate(nextDate.getDate() + Math.ceil(days)); nextStep++; }
            await updateDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', card.subject || currentSubject, 'saved_questions', card.id), { reviewStep: nextStep, nextReviewDate: nextDate });
        }
        
        function openEditModal(card, isNew = false) {
            if(!card) return;
            els.editQaTitle.textContent = isNew ? "Crear Nueva Flashcard" : "Editar Flashcard";
            els.editQaId.value = card.id || ''; els.editQaSubject.value = card.subject || currentSubject; 
            els.editQaQuestion.value = card.question || ''; els.editQaAnswer.value = card.answer || ''; els.editQaImage.value = card.imageUrl || '';
            els.editQaUnit.value = card.unit || 'General'; els.editQaTopic.value = card.topic || 'General'; 
            els.editQaModal.style.display = 'flex';
        }
        
        async function saveEditQa() {
            const id = els.editQaId.value;
            const subject = els.editQaSubject.value; 
            if (!subject || subject === 'all') return showError("Error de materia.");
            const data = { question: els.editQaQuestion.value, answer: els.editQaAnswer.value, imageUrl: els.editQaImage.value, unit: els.editQaUnit.value, topic: els.editQaTopic.value };
            try {
                if (id) await updateDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', subject, 'saved_questions', id), data);
                else await addDoc(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', subject, 'saved_questions'), { ...data, reviewStep: 0, nextReviewDate: serverTimestamp(), createdAt: serverTimestamp() });
                els.editQaModal.style.display = 'none';
                if (currentSubject === 'all') { if (currentTab === 'review') loadReviewData('all'); } else { if (currentTab === 'review') loadReviewData(currentSubject); if (currentTab === 'topics') loadTopicManager(); }
                const feedback = document.getElementById('flashcard-feedback'); if (feedback) feedback.style.display = 'none';
            } catch (e) { console.error(e); showError("Error al guardar."); }
        }

        function openEditMcqModal(qData) {
            els.editMcqId.value = qData.id;
            els.editMcqQuestion.value = qData.question;
            els.editMcqJustification.value = qData.justification || '';
            els.editMcqOptionsContainer.innerHTML = ''; 
            let correctIndex = qData.correctIndex !== undefined ? qData.correctIndex : qData.options.findIndex(opt => String(opt).trim() === String(qData.correctAnswer).trim());
            qData.options.forEach((option, index) => {
                const isChecked = (index === correctIndex);
                const optionEl = document.createElement('div');
                optionEl.className = 'flex items-center gap-2';
                optionEl.innerHTML = `<input type="radio" name="correct-option" value="${index}" ${isChecked ? 'checked' : ''} class="h-4 w-4 text-blue-600"><input type="text" value="${option}" class="edit-mcq-option-input w-full p-2 border border-gray-300 rounded">`;
                els.editMcqOptionsContainer.appendChild(optionEl);
            });
            els.editMcqModal.style.display = 'flex';
        }

        async function saveEditMcq() {
            const id = els.editMcqId.value;
            const newQuestion = els.editMcqQuestion.value;
            const newJustification = els.editMcqJustification.value;
            const newOptions = [];
            document.querySelectorAll('.edit-mcq-option-input').forEach(input => { newOptions.push(input.value); });
            const newCorrectIndex = parseInt(document.querySelector('input[name="correct-option"]:checked').value, 10);
            if (!id || !newQuestion || newOptions.length < 2 || newCorrectIndex < 0) return showError("Faltan datos.");
            const updatedData = { question: newQuestion, options: newOptions, justification: newJustification, correctIndex: newCorrectIndex, correctAnswer: newOptions[newCorrectIndex], isVerified: true };
            try {
                await updateDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq', id), updatedData);
                const cacheIndex = cachedMcqs.findIndex(q => q.id === id); if (cacheIndex > -1) cachedMcqs[cacheIndex] = { ...cachedMcqs[cacheIndex], ...updatedData };
                const practiceIndex = currentPracticeQuestions.findIndex(q => q.id === id); if (practiceIndex > -1) currentPracticeQuestions[practiceIndex] = { ...currentPracticeQuestions[practiceIndex], ...updatedData };
                els.editMcqModal.style.display = 'none';
                renderQuestion(); showError("Actualizado.", false);
            } catch (e) { console.error(e); showError("Error al guardar."); }
        }

        function renderRoadmapAccordions(groupedByDay, isGlobal) {
            els.roadmapList.innerHTML = ''; 
            for (const dateStr in groupedByDay) {
                const dayCards = groupedByDay[dateStr];
                const btn = document.createElement('button');
                btn.className = 'accordion-btn';
                btn.innerHTML = `<span>${dateStr} (${dayCards.length} tarjetas)</span><div class="flex items-center gap-2"><button class="practice-day-btn px-3 py-1 bg-blue-100 text-blue-700 font-semibold rounded-lg text-xs hover:bg-blue-200">Practicar este día</button><span class="toggle-icon" data-lucide="chevron-down"></span></div>`;
                const content = document.createElement('div');
                content.className = 'accordion-content p-4 space-y-1';
                content.innerHTML = dayCards.map(c => `<p class="text-sm text-gray-600 border-b pb-1">${isGlobal ? `<span class="font-bold text-purple-700">[${c.subject}]</span>` : ''} ${c.question.substring(0, 70)}...</p>`).join('');
                btn.querySelector('.practice-day-btn').onclick = (e) => { e.stopPropagation(); els.roadmapList.style.display = 'none'; els.roadmapPractice.style.display = 'block'; startAnkiSession(dayCards, els.roadmapPractice, () => { els.roadmapPractice.style.display = 'none'; els.roadmapList.style.display = 'block'; loadRoadmapData(currentSubject); }); };
                btn.onclick = (e) => { if (e.target.closest('.practice-day-btn')) return; toggleAccordion(btn, content); };
                els.roadmapList.appendChild(btn); els.roadmapList.appendChild(content);
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        async function loadTopicManager() {
            if (!currentSubject || currentSubject === 'all') { els.topicManagerList.innerHTML = '<p class="text-gray-400 text-center py-10">Selecciona una materia.</p>'; return; }
            els.topicManagerLoader.style.display = 'block'; els.topicManagerList.innerHTML = '';
            try {
                const mcqSnap = await getDocs(query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq')));
                const ankiSnap = await getDocs(query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions')));
                const allQuestions = [];
                mcqSnap.forEach(d => allQuestions.push({ id: d.id, type: 'mcq', ...d.data() }));
                ankiSnap.forEach(d => allQuestions.push({ id: d.id, type: 'anki', ...d.data() }));
                const groupedByTopic = allQuestions.reduce((acc, q) => { const topic = q.topic || "Sin Clasificar"; if (!acc[topic]) acc[topic] = []; acc[topic].push(q); return acc; }, {});
                els.topicManagerLoader.style.display = 'none';
                const globalDiv = document.createElement('div');
                globalDiv.className = 'border rounded-lg mb-2';
                globalDiv.innerHTML = `<button class="accordion-btn !bg-blue-50 !border-blue-200"><span class="font-bold text-blue-700">[+] Ver Todas las Preguntas (${allQuestions.length})</span><span class="toggle-icon" data-lucide="chevron-down"></span></button><div class="accordion-content p-4 space-y-2">${allQuestions.map(q => renderQuestionManagerRow(q)).join('')}</div>`;
                const globalBtn = globalDiv.querySelector('button'); const globalContent = globalDiv.querySelector('.accordion-content');
                globalBtn.onclick = () => toggleAccordion(globalBtn, globalContent);
                els.topicManagerList.appendChild(globalDiv);
                Object.keys(groupedByTopic).sort().forEach(topicName => {
                    const topicQuestions = groupedByTopic[topicName];
                    const div = document.createElement('div');
                    div.className = 'border rounded-lg mb-2';
                    div.innerHTML = `<button class="accordion-btn !bg-white !border-none !mb-0"><span class="flex items-center gap-2"><input type="checkbox" class="topic-select-box" data-topic-name="${topicName.replace(/"/g, "'")}"><span class="font-bold">${topicName}</span><span class="text-sm text-gray-500">(${topicQuestions.length} preguntas)</span></span><div class="flex items-center gap-2"><button class="rename-topic-btn px-3 py-1 bg-blue-100 text-blue-700 font-semibold rounded-lg text-xs hover:bg-blue-200">Renombrar</button><span class="toggle-icon" data-lucide="chevron-down"></span></div></button><div class="accordion-content p-4 space-y-2">${topicQuestions.map(q => renderQuestionManagerRow(q)).join('')}</div>`;
                    const topicBtn = div.querySelector('.accordion-btn'); const topicContent = div.querySelector('.accordion-content');
                    topicBtn.onclick = (e) => { if (e.target.closest('.rename-topic-btn')) return; toggleAccordion(topicBtn, topicContent); };
                    div.querySelector('.rename-topic-btn').onclick = (e) => { e.stopPropagation(); renombrarTema(topicName); };
                    els.topicManagerList.appendChild(div);
                });
                els.topicManagerList.querySelectorAll('input[type="checkbox"]').forEach(box => { box.onchange = updateTopicManagerControls; });
                els.topicManagerList.querySelectorAll('.edit-qa-inline-btn').forEach(btn => { btn.onclick = async (e) => { e.stopPropagation(); const cardId = e.target.dataset.id; const card = (await getDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions', cardId))).data(); openEditModal({id: cardId, subject: currentSubject, ...card}); } });
                els.topicManagerList.querySelectorAll('.delete-question-btn').forEach(btn => { btn.onclick = (e) => { e.stopPropagation(); handleDeleteQuestion(e.currentTarget.dataset.docId, e.currentTarget.dataset.type); } });
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (e) { console.error(e); els.topicManagerLoader.style.display = 'none'; els.topicManagerList.innerHTML = `<p class="text-red-500">Error al cargar temas.</p>`; }
        }
        
        function renderQuestionManagerRow(q) {
             return `<div class="flex items-center gap-2 p-2 border-b"><input type="checkbox" class="question-select-box" data-doc-id="${q.id}" data-type="${q.type}"><p class="text-sm flex-1"><span class="font-semibold ${q.type === 'mcq' ? 'text-purple-700' : 'text-blue-700'}">[${q.type.toUpperCase()}]</span> ${q.question} ${q.type === 'anki' ? `<button class="edit-qa-inline-btn text-xs text-blue-500 hover:underline ml-2" data-id="${q.id}">Editar</button>` : ''}</p><button class="delete-question-btn" data-doc-id="${q.id}" data-type="${q.type}"><svg data-lucide="trash-2" class="w-3 h-3"></svg></button></div>`;
        }
        
        function showConfirmModal(message, onConfirm) {
            els.confirmMsg.textContent = message; els.confirmModal.style.display = 'flex';
            els.confirmYes.replaceWith(els.confirmYes.cloneNode(true)); els.confirmYes = document.getElementById('confirm-yes');
            els.confirmYes.onclick = () => { onConfirm(); els.confirmModal.style.display = 'none'; };
        }
        
        async function handleDeleteQuestion(docId, type) {
            showConfirmModal("¿Eliminar pregunta? No se puede deshacer.", async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, type === 'mcq' ? 'saved_mcq' : 'saved_questions', docId));
                    showError("Eliminada.", false); loadTopicManager(); loadChoiceTopics();
                } catch (e) { console.error(e); showError("Error al eliminar."); }
            });
        }
        
        function toggleAccordion(btn, content) {
            const icon = btn.querySelector('.toggle-icon, .lucide-chevron-down');
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', String(!isExpanded));
            content.classList.toggle('open');
            if (icon) icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
        }
        
        function updateTopicManagerControls() {
            const selectedTopics = els.topicManagerList.querySelectorAll('.topic-select-box:checked').length;
            const selectedQuestions = els.topicManagerList.querySelectorAll('.question-select-box:checked').length;
            els.mergeTopicsBtn.disabled = selectedTopics < 2; els.createSubtopicBtn.disabled = selectedQuestions === 0;
        }

        async function renombrarTema(oldTopicName) {
            const newTopicName = prompt(`Renombrar tema "${oldTopicName}" a:`);
            if (!newTopicName || newTopicName.trim() === '' || newTopicName === oldTopicName) return;
            await updateTopicNames([oldTopicName], newTopicName); loadTopicManager();
        }

        async function mergeSelectedTopics() {
            const selectedTopics = Array.from(els.topicManagerList.querySelectorAll('.topic-select-box:checked')).map(box => box.dataset.topicName);
            if (selectedTopics.length < 2) return;
            const newTopicName = prompt(`Fusionar temas en:`);
            if (!newTopicName || newTopicName.trim() === '') return;
            await updateTopicNames(selectedTopics, newTopicName); loadTopicManager();
        }
        
        async function createSubtopicFromSelected() {
            const selectedQuestions = Array.from(els.topicManagerList.querySelectorAll('.question-select-box:checked'));
            if (selectedQuestions.length === 0) return;
            const newSubtopicName = prompt(`Nombre del nuevo subtema:`);
            if (!newSubtopicName || newSubtopicName.trim() === '') return;
            const batch = writeBatch(db);
            selectedQuestions.forEach(box => {
                const { docId, type } = box.dataset;
                batch.update(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, type === 'mcq' ? 'saved_mcq' : 'saved_questions', docId), { topic: newSubtopicName });
            });
            await batch.commit(); showError("Subtema creado.", false); loadTopicManager();
        }

        async function updateTopicNames(oldNames, newName) {
            try {
                const batch = writeBatch(db);
                const mcqSnap = await getDocs(query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_mcq'), where('topic', 'in', oldNames)));
                mcqSnap.forEach(d => batch.update(d.ref, { topic: newName }));
                const ankiSnap = await getDocs(query(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions'), where('topic', 'in', oldNames)));
                ankiSnap.forEach(d => batch.update(d.ref, { topic: newName }));
                await batch.commit(); showError("Actualizado.", false);
            } catch (e) { console.error(e); showError("Error al actualizar."); }
        }
        
                async function loadSyllabusBrowser(forceRegenerate = false) {
             if (!currentSubject || currentSubject === 'all') { els.syllabusBrowser.innerHTML = '<p class="text-gray-400 text-center py-10">Selecciona una materia.</p>'; return; }
            
             // 1. Intentar cargar desde DB si no forzamos regenerar
             if (!forceRegenerate) {
                 els.syllabusBrowser.innerHTML = '<div class="loader"></div><p class="text-center text-gray-500">Buscando estructura guardada...</p>';
                 try {
                     const docRef = doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'materials', 'syllabus_structure');
                     const docSnap = await getDoc(docRef);
                     if (docSnap.exists()) {
                         renderSyllabus(docSnap.data().structure);
                         // Mostrar botón de regenerar por si el usuario quiere actualizar
                         if(document.getElementById('regenerate-syllabus-btn')) {
                            document.getElementById('regenerate-syllabus-btn').style.display = 'flex';
                         }
                         return; // Terminamos aquí si cargó de DB
                     }
                 } catch (e) { console.warn("No se pudo cargar estructura guardada, generando nueva...", e); }
             }

            // 2. Si no existe guardada o forzamos regenerar: Generar con IA
            showProgress("Modo Estudio", "Analizando todo el material con IA...", 15);
            
            try {
                const syllabus = document.getElementById('syllabus').value;
                const theory = document.getElementById('theory').value;
                const experiences = document.getElementById('experiences').value;

                // Prioridad inteligente
                const smartContext = buildSmartContext(syllabus, theory, experiences, 300000, 'syllabus');
                
                const structuredSyllabus = await parseSyllabusWithAI(smartContext);
                
                showProgress("Modo Estudio", "Guardando estructura...", 90);
                
                // Guardar en DB para la próxima vez
                await setDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'materials', 'syllabus_structure'), { 
                    structure: structuredSyllabus, 
                    updatedAt: serverTimestamp() 
                });
                
                renderSyllabus(structuredSyllabus);
                
                if(document.getElementById('regenerate-syllabus-btn')) {
                    document.getElementById('regenerate-syllabus-btn').style.display = 'flex';
                }
                
                await sleep(500);
                hideProgress();
            } catch (e) { 
                hideProgress();
                console.error(e); 
                els.syllabusBrowser.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; 
            }
        }

        // Nueva función auxiliar para separar la lógica de visualización
        function renderSyllabus(structure) {
            const container = document.getElementById('syllabus-browser');
            container.innerHTML = '';
            if (!structure || structure.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No se encontraron temas.</p>';
                return;
            }
            structure.forEach(unit => {
                const div = document.createElement('div');
                div.innerHTML = `<button class="accordion-btn text-lg unit-toggle-btn">${unit.unit} <span class="toggle-icon" data-lucide="chevron-down"></span></button>`;
                const topicsContainer = document.createElement('div');
                topicsContainer.className = 'accordion-content';
                topicsContainer.innerHTML = unit.topics.map(t => `<button class="syllabus-topic-btn" data-unit="${unit.unit.replace(/"/g, "'")}" data-topic="${t.replace(/"/g, "'")}">${t}</button>`).join('');
                div.appendChild(topicsContainer); container.appendChild(div);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function regenerateSyllabus() {
            if(confirm("¿Seguro que quieres regenerar la estructura de temas? Esto analizará de nuevo los PDFs y sobrescribirá la organización actual.")) {
                loadSyllabusBrowser(true);
            }
        }

        //FIN PARCHE 5 
        
        async function parseSyllabusWithAI(fullMaterial) {
             const prompt = `Analiza el material (Priorizando Experiencias y Syllabus) y genera una estructura de temas lógica en JSON: [{ "unit": "Nombre Unidad", "topics": ["Tema 1", "Tema 2"] }] Material: ${fullMaterial}`;
            let txt = await callGeminiAPI(prompt, true);
            return parseJsonFromAi(txt);
        }

        async function handleStudyTopicSelect(topicButton) {
            const topicName = topicButton.dataset.topic; const unitName = topicButton.dataset.unit;
            
            els.syllabusBrowser.style.display = 'none'; 
            // els.topicManagerLoader.style.display = 'block';  // Ya no usamos este loader pequeño
            showProgress("Generando Guía", `Analizando tema: ${topicName}...`, 20);

            const output = document.getElementById('study-output'); output.innerHTML = '';
            
            try {
                const guideData = await generatePrioritizedStudyGuide(topicName, unitName);
                showProgress("Generando Guía", "Maquetando respuesta...", 90);
                renderStudyGuide(guideData, unitName);
                
                await sleep(500);
                hideProgress();
            } catch (error) { 
                hideProgress();
                console.error(error); showError(`Error: ${error.message}`); 
                els.syllabusBrowser.style.display = 'block'; // Volver a mostrar browser si falla
            } 
        }

        async function generatePrioritizedStudyGuide(topicName, unitName) {
            const syllabus = document.getElementById('syllabus').value;
            const theory = document.getElementById('theory').value;
            const experiences = document.getElementById('experiences').value;
            const smartContext = buildSmartContext(syllabus, theory, experiences, 300000, 'exam');

            const systemPrompt = "Eres Tutor Médico. Crea Guía de Estudio JSON. 5-7 subtemas con Importancia (Alta/Media/Baja), justificación y pregunta clave. PRIORIZA TEMAS DE EXPERIENCIAS DE EXAMEN.";
            const userQuery = `Tema: "${topicName}" (Unidad: "${unitName}") Material:\n${smartContext}\nGenera JSON.`;
            const jsonSchema = { type: "OBJECT", properties: { "topic": { "type": "STRING" }, "ai_summary": { "type": "STRING" }, "subtopics": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "subtopic_name": { "type": "STRING" }, "importance": { "type": "STRING" }, "justification": { "type": "STRING" }, "key_question": { "type": "STRING" } }, "required": ["subtopic_name", "importance", "justification", "key_question"] } } }, "required": ["topic", "ai_summary", "subtopics"] };
            const resultText = await callGeminiAPI(userQuery, true, systemPrompt, { responseMimeType: "application/json", responseSchema: jsonSchema }); 
            return JSON.parse(resultText);
        }

        function renderStudyGuide(guideData, unitName) {
            const output = document.getElementById('study-output'); output.innerHTML = ''; 
            const title = document.createElement('h2'); title.className = 'text-3xl font-bold text-gray-800 mb-4'; title.textContent = `Guía: ${guideData.topic}`;
            const summary = document.createElement('p'); summary.className = 'guide-summary'; summary.textContent = guideData.ai_summary;
            output.appendChild(title); output.appendChild(summary);
            guideData.subtopics.forEach(subtopic => {
                const block = document.createElement('div'); block.className = 'subtopic-block';
                let impClass = 'importance-badge-baja';
                if (subtopic.importance.toLowerCase().includes('alta')) impClass = 'importance-badge-alta';
                else if (subtopic.importance.toLowerCase().includes('media')) impClass = 'importance-badge-media';
                block.innerHTML = `<div class="subtopic-header"><h4>${subtopic.subtopic_name}</h4><span class="importance-badge ${impClass}">${subtopic.importance}</span></div><div class="subtopic-body"><p class="ai-justification">${subtopic.justification}</p><div class="key-question-wrapper">${createQuestionItemHTML(subtopic.key_question, unitName, guideData.topic)}</div><div class="sub-question-container"></div><div class="sub-question-loader loader"></div></div><button class="generate-more-btn" data-unit="${unitName}" data-topic="${guideData.topic}" data-subtopic="${subtopic.subtopic_name}"><svg data-lucide="plus" class="w-4 h-4"></svg> Generar más</button>`;
                output.appendChild(block);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        async function handleGenerateMoreQuestions(button) {
            const { unit, topic, subtopic } = button.dataset;
            const container = button.previousElementSibling.querySelector('.sub-question-container');
            const loader = button.previousElementSibling.querySelector('.sub-question-loader');
            button.disabled = true; loader.style.display = 'block';
            try {
                // Contexto simple para esto es suficiente, pero usaremos smart
                const syllabus = document.getElementById('syllabus').value;
                const theory = document.getElementById('theory').value;
                const experiences = document.getElementById('experiences').value;
                const smartContext = buildSmartContext(syllabus, theory, experiences, 50000, 'exam');

                const resultText = await callGeminiAPI(`Contexto: ${smartContext}\nTema: "${topic}", Subtema: "${subtopic}". Genera 3 preguntas examen oral cortas.`, false); 
                const newQuestions = resultText.split('\n').filter(q => q.trim().length > 0);
                newQuestions.forEach(q => { container.insertAdjacentHTML('beforeend', createQuestionItemHTML(q, unit, topic)); });
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (error) { container.innerHTML += '<p class="text-red-500">Error.</p>'; } 
            finally { button.disabled = false; loader.style.display = 'none'; }
        }
        
       // --- FUNCIÓN DE EDICIÓN MEJORADA ---
        function toggleEditItem(btn) {
            const container = btn.closest('.question-item');
            const qText = container.querySelector('.question-text');
            const aText = container.querySelector('.answer-text');
            
            // Usamos una clase para saber el estado real
            const isEditing = container.classList.contains('is-editing');
            
            if (isEditing) {
                // DESACTIVAR EDICIÓN (Guardar visualmente)
                container.classList.remove('is-editing');
                qText.contentEditable = "false";
                if(aText) aText.contentEditable = "false";
                
                // Quitar estilos de edición
                qText.classList.remove('bg-white', 'border-blue-300', 'shadow-inner');
                if(aText) aText.classList.remove('border-blue-500', 'ring-2', 'ring-blue-100');
                
                // Volver al ícono de lápiz
                btn.innerHTML = '<svg data-lucide="pencil" class="w-4 h-4"></svg>';
                btn.classList.remove('text-green-600', 'bg-green-100');
                btn.classList.add('text-gray-400');
            } else {
                // ACTIVAR EDICIÓN
                container.classList.add('is-editing');
                qText.contentEditable = "true";
                
                // Si existe respuesta, hacerla editable
                if(aText) {
                    aText.contentEditable = "true";
                    if (aText.style.display !== 'none') {
                        aText.classList.add('border-blue-500', 'ring-2', 'ring-blue-100');
                    }
                }
                
                // Estilos de edición para la pregunta
                qText.classList.add('bg-white', 'border-blue-300', 'shadow-inner');
                qText.focus();
                
                // Cambiar ícono a Check
                btn.innerHTML = '<svg data-lucide="check" class="w-4 h-4"></svg>';
                btn.classList.remove('text-gray-400');
                btn.classList.add('text-green-600', 'bg-green-100');
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        // --- NUEVA ESTRUCTURA DE PREGUNTA CON BOTÓN EDITAR ---
      function createQuestionItemHTML(question, unitName, topicName) {
    return `
        <div class="question-item py-4 group transition-all hover:bg-gray-50 rounded-lg px-2">
            <div class="flex justify-between items-start gap-2">
                <div class="question-text font-semibold text-gray-800 p-2 rounded border border-transparent flex-1 outline-none transition-all focus:ring-2 focus:ring-blue-200">${question}</div>
                
                <button class="edit-item-btn text-gray-400 hover:text-blue-600 p-2 rounded transition-colors flex items-center gap-1" title="Activar Edición">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/>
                    </svg>
                </button>
            </div>
            
            <div class="flex gap-2 mt-2 pl-2">
                <button class="answer-btn px-4 py-1.5 bg-blue-100 text-blue-700 text-sm font-bold rounded-md hover:bg-blue-200 transition-colors inline-flex items-center" data-question="${question.replace(/"/g, '&quot;')}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> Responder
                    <div class="answer-loader" style="display: none;"></div>
                </button>
                
                <button class="audio-btn ml-2 px-4 py-1.5 bg-purple-100 text-purple-700 text-sm font-bold rounded-md hover:bg-purple-200 transition-colors inline-flex items-center" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg> Escuchar
                    <div class="audio-loader loader w-3 h-3 ml-2 border-purple-500 border-t-transparent" style="display: none;"></div>
                </button>

                <button class="save-btn ml-2 px-4 py-1.5 bg-green-100 text-green-700 text-sm font-bold rounded-md hover:bg-green-200 transition-colors inline-flex items-center" data-topic="${topicName}" data-unit="${unitName}" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Guardar
                </button>
            </div>

            <div class="answer-text mt-3 mx-2 p-3 text-sm text-gray-700 bg-white border border-gray-200 rounded-lg shadow-sm outline-none transition-all" contenteditable="false" style="display: none;"></div>
            <div class="audio-player-container px-2 mt-2"></div>
        </div>
    `;
}

        async function handleAnswerClick(button) {
    const question = button.dataset.question; 
    const container = button.closest('.question-item');
    const loader = button.querySelector('.answer-loader'); 
    const answerTextEl = container.querySelector('.answer-text');
    const audioBtn = container.querySelector('.audio-btn'); // Referencia al botón audio
    const saveButton = container.querySelector('.save-btn'); 
    
    button.disabled = true; 
    loader.style.display = 'inline-block';
    answerTextEl.style.display = 'none'; 
    answerTextEl.innerHTML = 'Generando respuesta...'; 
    saveButton.style.display = 'none'; 
    if(audioBtn) audioBtn.style.display = 'none';
    
    try {
        answerTextEl.style.display = 'block';
        
        const syllabus = document.getElementById('syllabus').value;
        const theory = document.getElementById('theory').value;
        const experiences = document.getElementById('experiences').value;
        
        const smartContext = buildSmartContext(syllabus, theory, experiences, 100000, 'exam');

        const answerText = await callGeminiAPI(`Responde conciso para examen oral: "${question}". Usa **negrita** para claves. Contexto: ${smartContext}`, false);
        
        // Renderizar HTML
        answerTextEl.innerHTML = answerText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        
        // Si estaba editando, mantener estado
        if (container.classList.contains('is-editing')) {
            answerTextEl.contentEditable = "true";
            answerTextEl.classList.add('border-blue-500', 'ring-2', 'ring-blue-100');
        }

        // AQUÍ ESTÁ EL CAMBIO: Ya no llamamos a callGeminiTTS automáticamente.
        // En su lugar, mostramos los botones para que el usuario decida.
        
        saveButton.style.display = 'inline-flex'; 
        saveButton.disabled = false;

        if(audioBtn) {
            audioBtn.style.display = 'inline-flex';
            audioBtn.disabled = false;
        }
        
        if (typeof lucide !== 'undefined') lucide.createIcons();
    } catch (error) { 
        console.error(error); 
        answerTextEl.innerHTML = `Error: ${error.message}`; 
    } finally { 
        button.disabled = false; 
        loader.style.display = 'none'; 
    }
}
//LEE LO QUE HAY ACTUALMENTE EN EL CUADRO DE TEXTO 
        async function handleAudioClick(button) {
    const container = button.closest('.question-item');
    const answerTextEl = container.querySelector('.answer-text');
    const audioPlayerContainer = container.querySelector('.audio-player-container');
    const loader = button.querySelector('.audio-loader');
    
    // 1. Obtener el texto ACTUAL (por si el usuario lo editó)
    // Usamos innerText para evitar leer etiquetas HTML como <br> o <b> en el audio
    const textToRead = answerTextEl.innerText; 

    if(!textToRead.trim()) return alert("No hay texto para leer.");

    button.disabled = true;
    if(loader) loader.style.display = 'inline-block';
    audioPlayerContainer.innerHTML = ''; // Limpiar audio previo

    try {
        // 2. Llamar a la API de TTS con el texto editado
        const { audioData, mimeType } = await callGeminiTTS(textToRead);
        
        // 3. Reproducir
        await playAudio(audioData, mimeType, audioPlayerContainer);
        
    } catch (error) {
        console.error("Error TTS:", error);
        alert("Error al generar el audio. Revisa la consola.");
    } finally {
        button.disabled = false;
        if(loader) loader.style.display = 'none';
    }
}
        //FIN LECTURA CUADRO DE TEXTO 
            
                  async function handleSaveClick(button) {
            const container = button.closest('.question-item');
            // Leer el texto del DOM porque puede haber sido editado
            const question = container.querySelector('.question-text').innerText.trim();
            const answer = container.querySelector('.answer-text').innerHTML;
            const { topic, unit } = button.dataset;

            if (!currentSubject) return showError("Selecciona materia.");
            button.disabled = true; button.innerHTML = "Guardando...";
            try {
                await addDoc(collection(db, 'artifacts', firebaseConfig.projectId, 'users', userId, 'subjects', currentSubject, 'saved_questions'), { 
                    unit, topic, question, answer, 
                    createdAt: serverTimestamp(), reviewStep: 0, nextReviewDate: serverTimestamp() 
                });
                button.innerHTML = "¡Guardado!";
                
                // Si estaba en modo edición, salir para confirmar visualmente
                const editBtn = container.querySelector('.edit-item-btn');
                const qText = container.querySelector('.question-text');
                if (qText.isContentEditable && editBtn) toggleEditItem(editBtn);

                if (currentTab === 'review') loadReviewData(currentSubject);
            } catch (error) { console.error(error); showError("Error guardando."); button.disabled = false; button.innerHTML = "Reintentar"; }
        }

        async function callGeminiTTS(text) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            const payload = { contents: [{ parts: [{ text: `Di con tono claro: ${text}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } } };
            const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!resp.ok) throw new Error("TTS Error");
            const res = await resp.json(); return { audioData: res.candidates[0].content.parts[0].inlineData.data, mimeType: res.candidates[0].content.parts[0].inlineData.mimeType };
        }

        async function playAudio(b64, mime, container) {
            const bin = atob(b64); const len = bin.length; const bytes = new Uint8Array(len); for (let i=0; i<len; i++) bytes[i] = bin.charCodeAt(i);
            const pcm16 = new Int16Array(bytes.buffer);
            const wavBlob = pcmToWav(pcm16, 24000); 
            const url = URL.createObjectURL(wavBlob); container.innerHTML = `<audio src="${url}" controls autoplay></audio>`;
        }

        function pcmToWav(pcm, rate) {
            const buff = new ArrayBuffer(44 + pcm.byteLength); const view = new DataView(buff);
            const writeS = (o, s) => { for (let i=0; i<s.length; i++) view.setUint8(o+i, s.charCodeAt(i)); };
            writeS(0, 'RIFF'); view.setUint32(4, 36+pcm.byteLength, true); writeS(8, 'WAVE'); writeS(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, rate, true);
            view.setUint32(28, rate*2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeS(36, 'data');
            view.setUint32(40, pcm.byteLength, true);
            for (let i=0; i<pcm.length; i++) view.setInt16(44+i*2, pcm[i], true);
            return new Blob([view], { type: 'audio/wav' });
        }

        function resetModes() {
            els.studyContainer.classList.add('hidden'); els.examContainer.classList.add('hidden');
            els.modeSelection.classList.remove('hidden'); els.syllabusBrowser.innerHTML = '<p class="text-gray-400">Cargando...</p>';
            document.getElementById('study-output').innerHTML = ''; els.syllabusBrowser.style.display = 'block';
        }
        
        async function generateOralExam() {
            const out = document.getElementById('exam-output'); out.innerHTML = "Generando...";
            const prompt = `Genera 3 preguntas orales sobre: ${document.getElementById('syllabus').value.substring(0,1000)}...`;
            const res = await callGeminiAPI(prompt, false); out.innerHTML = `<div class="p-4 bg-white border rounded">${res.replace(/\n/g, '<br>')}</div>`;
        }

        function toggleFocusMode() {
            const sidebar = document.getElementById('choice-sidebar-col');
            const mainContent = document.getElementById('choice-main-col');
            const button = document.getElementById('toggle-sidebar-btn');
            if (!sidebar || !mainContent || !button) return;
            const isHidden = sidebar.classList.contains('hidden');
            if (isHidden) {
                sidebar.classList.remove('hidden'); mainContent.classList.remove('lg:col-span-3'); mainContent.classList.add('lg:col-span-2');
                button.innerHTML = `<svg data-lucide="panel-left-close" class="w-5 h-5"></svg>`; button.title = "Ocultar panel";
            } else {
                sidebar.classList.add('hidden'); mainContent.classList.remove('lg:col-span-2'); mainContent.classList.add('lg:col-span-3');
                button.innerHTML = `<svg data-lucide="panel-right-close" class="w-5 h-5"></svg>`; button.title = "Mostrar panel";
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        const API_KEY = "AIzaSyCcnQiY3wkGkJpOotfJxyVQg4fi2OKzHhY"; 

        async function callGeminiAPI(userQuery, expectJson, systemPrompt = null, generationConfig = null) {
           const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }] };
            if (systemPrompt) payload.systemInstruction = { parts: [{ text: systemPrompt }] };
            let finalGenConfig = generationConfig || {};
            if (expectJson && !finalGenConfig.responseMimeType) finalGenConfig.responseMimeType = "application/json";
            if (Object.keys(finalGenConfig).length > 0) payload.generationConfig = finalGenConfig;
            
            let retries = 5; 
            let delay = 2000;
            
            while (retries > 0) {
                try {
                    const resp = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    if (!resp.ok) throw new Error(`API Error: ${resp.status}`);
                    const json = await resp.json();
                    return json.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.warn(`Intento fallido. Reintentando en ${delay/1000}s... Error:`, error);
                    retries--;
                    if (retries === 0) throw error;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }

        function showError(msg, isError = true) {
            const m = document.getElementById('error-modal');
            document.getElementById('error-msg').textContent = msg;
            const h = document.getElementById('error-title');
            h.textContent = isError ? "Error" : "Éxito"; h.className = isError ? "text-red-600 font-bold text-lg mb-2" : "text-green-600 font-bold text-lg mb-2";
            m.style.display = 'flex';
        }

        // --- CONTEXTO INTELIGENTE (PRIORIDAD DINÁMICA) ---
        function buildSmartContext(syllabus, theory, experiences, limit = 300000, priorityMode = 'exam') {
            let context = "";
            
            if (priorityMode === 'syllabus') {
                 // MODO ESTRUCTURA: Prioridad 1 = Syllabus (Para que no se corte la lista de temas)
                context += "--- PLAN DE ESTUDIO (ALTA PRIORIDAD) ---\n";
                context += syllabus.substring(0, limit) + "\n\n";
                
                if (context.length >= limit) return context;

                // Prioridad 2: Experiencias
                let remaining = limit - context.length;
                context += "--- EXPERIENCIAS Y EXÁMENES ---\n";
                context += experiences.substring(0, remaining) + "\n\n";
                
                if (context.length >= limit) return context;
            } else {
                // MODO EXAMEN (Default): Prioridad 1 = Experiencias (Para preguntar lo que se toma)
                context += "--- EXPERIENCIAS Y EXÁMENES PASADOS (ALTA PRIORIDAD) ---\n";
                context += experiences.substring(0, limit) + "\n\n";
                
                if (context.length >= limit) return context;

                // Prioridad 2: Syllabus
                let remaining = limit - context.length;
                context += "--- PLAN DE ESTUDIO ---\n";
                context += syllabus.substring(0, remaining) + "\n\n";
                
                if (context.length >= limit) return context;
            }

            // Prioridad 3 (siempre última): Teoría
            let remaining = limit - context.length;
            if (remaining > 0) {
                context += "--- TEORÍA Y APUNTES ---\n";
                context += theory.substring(0, remaining);
            }

            return context;
        }

      async function init() {
            // 1. Primero activamos los botones
            setupListeners(); 

            // 2. Configuramos el observador
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    if (!userId) {
                        document.getElementById('sync-modal').style.display = 'flex';
                    } else {
                        document.getElementById('user-id').textContent = userId;
                        document.getElementById('sync-id-display').style.display = 'block';
                        document.getElementById('sync-modal').style.display = 'none';
                        
                        await loadSubjects(); 
                        els.subjectHeader.style.display = 'block'; 
                        switchTab(currentTab); 
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            });

            // 3. Intentamos entrar
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error crítico:", error);
            }
        }

       init(); 

    </script>
</body>
</html>
